<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>EnvÃ­oEco â€“ SimulaciÃ³n</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;600;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --red:#D40511;--yellow:#FFCC00;
  --green:#2e7d32;--green2:#4caf50;--green3:#a5d6a7;
  --blue:#1565c0;--blue2:#42a5f5;
  --dark:#ffffff;--panel:#f5f5f5;--panel2:#efefef;--border:#d0d0d0;
  --txt:#111111;--muted:#777;--muted2:#555;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:var(--dark);color:var(--txt);font-family:'DM Sans',sans-serif;display:flex;flex-direction:column;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:var(--yellow);padding:9px 28px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.hdr-logo{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--red);letter-spacing:1px;}
.hdr-title{font-size:13px;font-weight:800;color:#111;}
.hdr-sub{font-size:10px;color:#666;}
.hdr-right{display:flex;align-items:center;gap:8px;}
.day-pill{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1px;color:#555;background:#fff;border-radius:20px;padding:3px 12px;}
.btn-play{background:var(--red);color:#fff;border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:1px;padding:8px 24px;border-radius:6px;transition:opacity .2s;}
.btn-play:hover:not(:disabled){opacity:.85;}
.btn-play:disabled{opacity:.4;cursor:default;}
.btn-sm{background:transparent;color:#555;border:1.5px solid #888;cursor:pointer;font-size:11px;font-weight:700;padding:7px 13px;border-radius:6px;transition:all .2s;}
.btn-sm:hover{color:#111;border-color:#111;}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;flex-shrink:0;border-bottom:2px solid var(--border);}
.tab{padding:10px 28px;font-size:12px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;cursor:pointer;color:var(--muted);border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;user-select:none;}
.tab:hover{color:var(--txt);}
.tab.active.eco-tab{color:var(--green2);border-bottom-color:var(--green2);}
.tab.active.biz-tab{color:var(--yellow);border-bottom-color:var(--yellow);}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;flex:1;overflow:hidden;}
.page.active{display:flex;flex-direction:column;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ECO PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.eco-main{flex:1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr auto;overflow:hidden;}
.side{display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border);}
.side:last-of-type{border-right:none;}
.side-hdr{padding:10px 18px;flex-shrink:0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.side-hdr.lhdr{background:rgba(212,5,17,.1);}
.side-hdr.rhdr{background:rgba(46,125,50,.12);}
.side-badge{font-size:9px;font-weight:800;letter-spacing:.8px;text-transform:uppercase;padding:2px 9px;border-radius:20px;flex-shrink:0;}
.side-badge.r{background:var(--red);color:#fff;}
.side-badge.g{background:var(--green);color:#fff;}
.side-title{font-size:12px;font-weight:800;}
.side-desc{font-size:9px;color:var(--muted);}
.side-scroll{flex:1;overflow-y:auto;padding:12px 16px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.drow{margin-bottom:10px;opacity:0;transition:opacity .3s;}
.drow.show{opacity:1;}
.dname{font-size:9px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;display:flex;align-items:center;gap:5px;}
.dname::after{content:'';flex:1;border-top:1px solid var(--border);}
.t-track{display:flex;flex-wrap:wrap;gap:6px;min-height:44px;align-items:flex-start;}
.tcard{display:flex;flex-direction:column;align-items:center;gap:2px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:5px 7px;opacity:0;transform:scale(.7);transition:opacity .35s,transform .35s cubic-bezier(.175,.885,.32,1.275);}
.tcard.pop{opacity:1;transform:scale(1);}
.tcard.rc{border-color:var(--red);}
.tcard.gc{border-color:var(--green2);}
.temoji{font-size:22px;line-height:1;}
.tsmoke{font-size:10px;min-height:13px;}
.spuff{display:inline-block;opacity:0;}
.spuff.emit{animation:smoke 1.6s ease-out forwards;}
@keyframes smoke{0%{opacity:.7;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-10px) scale(1.6);}}
.tlabel{font-size:9px;font-weight:700;}
.tlabel.rl{color:var(--red);}
.tlabel.gl{color:var(--green2);}
.parea{background:#ececec;border:1px dashed #bbb;border-radius:7px;padding:6px 9px;min-height:34px;display:flex;flex-wrap:wrap;gap:3px;align-items:center;}
.plabel{font-size:9px;font-weight:800;letter-spacing:.3px;text-transform:uppercase;color:#777;width:100%;margin-bottom:3px;}
.pdot{font-size:13px;opacity:0;transition:opacity .2s,transform .2s;transform:scale(.3);}
.pdot.show{opacity:1;transform:scale(1);}
.pdot.gone{opacity:.1;transform:scale(.8);}
/* bottom bar */
.bbar{grid-column:1/-1;border-top:1px solid var(--border);background:#f8f8f8;padding:11px 18px;display:grid;grid-template-columns:1fr 1fr;gap:12px;flex-shrink:0;}
.mgroup{display:flex;gap:9px;}
.metric{flex:1;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 11px;position:relative;overflow:hidden;}
.ml{font-size:9px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);}
.mv{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:1px;line-height:1.1;transition:color .3s;}
.ms{font-size:9px;color:var(--muted);}
.metric.rm .mv{color:var(--red);}
.metric.gm .mv{color:var(--green2);}
.mfill{position:absolute;bottom:0;left:0;width:100%;height:3px;}
.mfill.rf{background:var(--red);}
.mfill.gf{background:var(--green2);}
/* streak */
.streak{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid var(--green);border-radius:30px;padding:5px 18px;font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;color:var(--green);white-space:nowrap;opacity:0;transition:opacity .3s;z-index:50;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.15);}
.streak.show{opacity:1;}
/* eco final overlay */
.fover{position:fixed;inset:0;background:rgba(0,0,0,.93);display:none;align-items:center;justify-content:center;z-index:100;cursor:pointer;}
.fover.show{display:flex;animation:fin .5s ease;}
@keyframes fin{from{opacity:0}to{opacity:1}}
.fcard{background:linear-gradient(150deg,#0d1f0d,#090909);border:2px solid var(--green);border-radius:20px;padding:34px 48px;max-width:800px;width:92%;text-align:center;animation:fpop .5s cubic-bezier(.175,.885,.32,1.275);}
@keyframes fpop{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.ftitle{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;color:var(--green2);margin-bottom:4px;}
.fsub{font-size:12px;color:#777;margin-bottom:22px;}
.fnums{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.fn{background:#0c1e0c;border:1px solid var(--green);border-radius:12px;padding:16px 12px;}
.fnl{font-size:9px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;color:var(--green3);}
.fnv{font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:1px;color:#fff;line-height:1;}
.fns{font-size:11px;color:var(--green2);font-weight:700;margin-top:2px;}
.fequiv{background:#111;border:1px solid #1e1e1e;border-radius:10px;padding:12px 18px;font-size:12px;color:#999;line-height:1.7;}
.fequiv strong{color:var(--green2);}
.fhint{font-size:10px;color:#333;margin-top:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUSINESS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.biz-page{background:var(--dark);overflow-y:auto;padding:20px 28px;}

/* KPI row */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.kpi{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;position:relative;overflow:hidden;}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.kpi.kred::before{background:var(--red);}
.kpi.kgrn::before{background:var(--green2);}
.kpi.kyel::before{background:var(--yellow);}
.kpi.kblu::before{background:var(--blue2);}
.kpi-label{font-size:9px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;color:var(--muted2);margin-bottom:6px;}
.kpi-val{font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:1px;line-height:1;}
.kpi-val.red{color:var(--red);}
.kpi-val.grn{color:var(--green2);}
.kpi-val.yel{color:var(--yellow);}
.kpi-val.blu{color:var(--blue2);}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}
.kpi-delta{font-size:11px;font-weight:800;margin-top:4px;}
.kpi-delta.up{color:var(--green2);}
.kpi-delta.dn{color:var(--red);}

/* Charts grid */
.charts-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px;}
.charts-grid.bottom{grid-template-columns:1fr 1fr;}
.chart-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:16px 18px;}
.chart-title{font-size:11px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:var(--muted2);margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.chart-title .ct-badge{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:800;}
.ct-badge.grn{background:rgba(76,175,80,.15);color:var(--green2);}
.ct-badge.red{background:rgba(212,5,17,.12);color:var(--red);}
.ct-badge.yel{background:rgba(255,204,0,.12);color:#d4a017;}
.chart-wrap{position:relative;}

/* ROI table */
.roi-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:6px;}
.roi-table thead th{padding:7px 10px;text-align:left;font-size:9px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.roi-table tbody td{padding:8px 10px;border-bottom:1px solid #e0e0e0;color:var(--txt);}
.roi-table tbody tr:hover{background:#f0f0f0;}
.roi-table .good{color:var(--green2);font-weight:800;}
.roi-table .bad{color:var(--red);font-weight:700;}
.roi-table .neutral{color:var(--yellow);font-weight:700;}

/* Scenario selector */
.scenario-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
.scenario-bar label{font-size:11px;font-weight:800;color:var(--muted2);letter-spacing:.4px;text-transform:uppercase;}
.scen-btn{background:var(--panel2);border:1px solid var(--border);color:var(--muted2);font-size:11px;font-weight:700;padding:6px 16px;border-radius:20px;cursor:pointer;transition:all .2s;}
.scen-btn.active{background:var(--yellow);color:#111;border-color:var(--yellow);}
.scen-btn:hover:not(.active){border-color:var(--txt);color:var(--txt);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="hdr-logo">DHL</div>
    <div>
      <div class="hdr-title">EnvÃ­oEco â€” SimulaciÃ³n de impacto</div>
      <div class="hdr-sub">7 dÃ­as Â· Zona 28931 Â· 72 paquetes</div>
    </div>
  </div>
  <div class="hdr-right">
    <div class="day-pill" id="dpill">DÃA 0 / 7</div>
    <button class="btn-sm" onclick="resetSim()">â†º Reiniciar</button>
    <button class="btn-play" id="bplay" onclick="startSim()">â–¶ INICIAR</button>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab eco-tab active" onclick="switchTab('eco')">ğŸŒ¿ Impacto Medioambiental</div>
  <div class="tab biz-tab" onclick="switchTab('biz')">ğŸ“Š Impacto econÃ³mico</div>
</div>

<!-- â•â• ECO PAGE â•â• -->
<div class="page active" id="page-eco">
  <div class="eco-main">
    <div class="side">
      <div class="side-hdr lhdr">
        <span class="side-badge r">SITUACIÃ“N ACTUAL</span>
        <div>
          <div class="side-title">Sin EnvÃ­oEco</div>
          <div class="side-desc">Un camiÃ³n cada dÃ­a Â· sin consolidar Â· siempre a media carga</div>
        </div>
      </div>
      <div class="side-scroll" id="lscroll"></div>
    </div>
    <div class="side">
      <div class="side-hdr rhdr">
        <span class="side-badge g">CON ENVÃOECO</span>
        <div>
          <div class="side-title">Algoritmo de consolidaciÃ³n</div>
          <div class="side-desc">Acumula paquetes Â· sale cuando la ruta es rentable</div>
        </div>
      </div>
      <div class="side-scroll" id="rscroll"></div>
    </div>
    <div class="bbar">
      <div class="mgroup">
        <div class="metric rm">
          <div class="ml">ğŸš› Camiones (actual)</div>
          <div class="mv" id="lt">0</div>
          <div class="ms">rutas lanzadas</div>
          <div class="mfill rf"></div>
        </div>
        <div class="metric rm">
          <div class="ml">â˜ï¸ COâ‚‚ (actual)</div>
          <div class="mv" id="lc">0 kg</div>
          <div class="ms">emisiones acumuladas</div>
          <div class="mfill rf"></div>
        </div>
      </div>
      <div class="mgroup">
        <div class="metric gm">
          <div class="ml">ğŸš› Camiones (EnvÃ­oEco)</div>
          <div class="mv" id="rt">0</div>
          <div class="ms">rutas lanzadas</div>
          <div class="mfill gf"></div>
        </div>
        <div class="metric gm">
          <div class="ml">ğŸŒ¿ COâ‚‚ (EnvÃ­oEco)</div>
          <div class="mv" id="rc">0 kg</div>
          <div class="ms">emisiones acumuladas</div>
          <div class="mfill gf"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• BUSINESS PAGE â•â• -->
<div class="page" id="page-biz">
  <div class="biz-page" id="biz-scroll">

    <!-- Scenario selector -->
    <div class="scenario-bar">
      <label>Escenario:</label>
      <button class="scen-btn active" onclick="setScenario('week',this)">1 semana</button>
      <button class="scen-btn" onclick="setScenario('month',this)">1 mes</button>
      <button class="scen-btn" onclick="setScenario('year',this)">1 aÃ±o</button>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi kred">
        <div class="kpi-label">Coste actual (sin Eco)</div>
        <div class="kpi-val red" id="kpi-cost-before">420â‚¬</div>
        <div class="kpi-sub" id="kpi-cost-before-sub">7 rutas Ã— 60â‚¬</div>
      </div>
      <div class="kpi kgrn">
        <div class="kpi-label">Coste con EnvÃ­oEco</div>
        <div class="kpi-val grn" id="kpi-cost-after">180â‚¬</div>
        <div class="kpi-sub" id="kpi-cost-after-sub">3 rutas Ã— 60â‚¬</div>
        <div class="kpi-delta up" id="kpi-cost-delta">â–¼ âˆ’57% de coste</div>
      </div>
      <div class="kpi kyel">
        <div class="kpi-label">Ahorro neto</div>
        <div class="kpi-val yel" id="kpi-saving">240â‚¬</div>
        <div class="kpi-sub" id="kpi-saving-sub">en la semana simulada</div>
      </div>
      <div class="kpi kgrn">
        <div class="kpi-label">COâ‚‚ evitado</div>
        <div class="kpi-val grn" id="kpi-co2">48 kg</div>
        <div class="kpi-sub" id="kpi-co2-sub">â‰ˆ 57% menos emisiones</div>
      </div>
      <div class="kpi kblu">
        <div class="kpi-label">OcupaciÃ³n media camiÃ³n</div>
        <div class="kpi-val blu" id="kpi-fill">72%</div>
        <div class="kpi-sub" id="kpi-fill-sub">vs 20% sin algoritmo</div>
        <div class="kpi-delta up">â–² +52 puntos</div>
      </div>
    </div>

    <!-- 3 charts top -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">ğŸ“¦ Rutas lanzadas
          <span class="ct-badge red">Actual vs Eco</span>
        </div>
        <div class="chart-wrap" style="height:180px"><canvas id="ch-routes"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">â˜ï¸ Emisiones COâ‚‚ acumuladas
          <span class="ct-badge grn">DÃ­a a dÃ­a</span>
        </div>
        <div class="chart-wrap" style="height:180px"><canvas id="ch-co2line"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ’¶ DistribuciÃ³n del coste
          <span class="ct-badge yel">Desglose</span>
        </div>
        <div class="chart-wrap" style="height:180px"><canvas id="ch-pie"></canvas></div>
      </div>
    </div>

    <!-- 2 charts bottom -->
    <div class="charts-grid bottom">
      <div class="chart-card">
        <div class="chart-title">ğŸ“ˆ Coste logÃ­stico acumulado
          <span class="ct-badge red">Actual</span>
          <span class="ct-badge grn">EnvÃ­oEco</span>
        </div>
        <div class="chart-wrap" style="height:160px"><canvas id="ch-cost"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">ğŸ­ ROI por zona postal â€” proyecciÃ³n mensual</div>
        <table class="roi-table">
          <thead>
            <tr>
              <th>Zona</th>
              <th>Rutas ahorradas</th>
              <th>Ahorro â‚¬/mes</th>
              <th>COâ‚‚ evitado</th>
              <th>ROI</th>
            </tr>
          </thead>
          <tbody id="roi-tbody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Streak & Eco final overlay -->
<script src="dashboard-stats.js"></script>
<div class="streak" id="streak">ğŸŒ¿ COâ‚‚ ahorrado: 0 kg</div>
<div class="fover" id="fover" onclick="this.classList.remove('show')">
  <div class="fcard">
    <div class="ftitle">ğŸŒ¿ Impacto de EnvÃ­oEco en 7 dÃ­as</div>
    <div class="fsub">Zona 28931 Â· 72 paquetes Â· OptimizadorEcoPuntosFinal</div>
    <div class="fnums">
      <div class="fn"><div class="fnl">Rutas ahorradas</div><div class="fnv" id="fn1">â€”</div><div class="fns" id="fn1s">â€”</div></div>
      <div class="fn"><div class="fnl">COâ‚‚ evitado</div><div class="fnv" id="fn2">â€”</div><div class="fns" id="fn2s">â€”</div></div>
      <div class="fn"><div class="fnl">ReducciÃ³n</div><div class="fnv" id="fn3">â€”</div><div class="fns">de las emisiones</div></div>
    </div>
    <div class="fequiv" id="fequiv"></div>
    <div class="fhint">Toca para cerrar Â· cambia a "AnÃ¡lisis de Negocio" para ver el impacto econÃ³mico</div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ECO SIMULATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DAYS=7, DAY_NAMES=['Lun 25','Mar 26','MiÃ© 27','Jue 28','Vie 1','SÃ¡b 2','Dom 3'];
const DAILY_PKGS=[8,11,7,14,9,13,10];
const CO2_TRUCK=12, THRESHOLD=22, STEP_MS=1500, TRUCK_CAP=50, COST_TRUCK=60;
let timer=null,curDay=0,running=false;
const L={t:0,co2:0,cost:0}, R={t:0,co2:0,cost:0,pending:0,dots:[]};
// live data for biz charts
const liveL={routes:[],co2:[],cost:[]}, liveR={routes:[],co2:[],cost:[]};

function animNum(id,val,suf=''){
  const el=document.getElementById(id);if(!el)return;
  const from=parseFloat(el.textContent)||0;
  const t0=performance.now();
  (function tick(now){const p=Math.min(1,(now-t0)/500);el.textContent=Math.round(from+(val-from)*p)+suf;if(p<1)requestAnimationFrame(tick);})(performance.now());
}
function scrollB(id){const e=document.getElementById(id);if(e)setTimeout(()=>e.scrollTop=e.scrollHeight,80);}
function makeTruck(cid,pkgs,side){
  const w=document.getElementById(cid);if(!w)return;
  const g=side==='r';
  const n=pkgs<=15?1:pkgs<=30?2:3;
  const c=document.createElement('div');c.className=`tcard ${g?'gc':'rc'}`;
  c.innerHTML=`<div class="temoji">ğŸš›</div><div class="tsmoke">${[...Array(n)].map(()=>`<span class="spuff">ğŸ’¨</span>`).join('')}</div><div class="tlabel ${g?'gl':'rl'}">${pkgs}p Â· ${pkgs<=15?'bajo':pkgs<=30?'medio':'lleno'}</div>`;
  w.appendChild(c);requestAnimationFrame(()=>{c.offsetHeight;c.classList.add('pop');});
  setTimeout(()=>c.querySelectorAll('.spuff').forEach((s,i)=>setTimeout(()=>s.classList.add('emit'),i*200)),400);
}
function makeLDay(d,pkgs){
  const div=document.createElement('div');div.className='drow';div.id=`ld${d}`;
  div.innerHTML=`<div class="dname">${DAY_NAMES[d]} Â· +${pkgs} paquetes</div><div class="t-track" id="lt${d}"></div>`;
  document.getElementById('lscroll').appendChild(div);requestAnimationFrame(()=>div.classList.add('show'));
}
function makeRDay(d,pkgs){
  const div=document.createElement('div');div.className='drow';div.id=`rd${d}`;
  div.innerHTML=`<div class="dname">${DAY_NAMES[d]} Â· +${pkgs} paquetes</div><div class="parea" id="rp${d}"><div class="plabel" id="rpl${d}">en cola</div></div><div class="t-track" id="rt${d}" style="margin-top:5px"></div>`;
  document.getElementById('rscroll').appendChild(div);requestAnimationFrame(()=>div.classList.add('show'));
}
function addDots(d,count){
  const area=document.getElementById(`rp${d}`);if(!area)return;
  for(let i=0;i<count;i++){const dot=document.createElement('span');dot.className='pdot';dot.textContent='ğŸ“¦';area.appendChild(dot);R.dots.push(dot);setTimeout(()=>{dot.offsetHeight;dot.classList.add('show');},i*45);}
}
function clearDots(){R.dots.forEach(d=>{d.classList.remove('show');d.classList.add('gone');});R.dots=[];}
function updateStreak(){const s=L.co2-R.co2;if(s<=0)return;const el=document.getElementById('streak');el.textContent=`ğŸŒ¿ COâ‚‚ ahorrado: ${s} kg`;el.classList.add('show');}

function stepDay(d){
  const pkgs=DAILY_PKGS[d];
  document.getElementById('dpill').textContent=`DÃA ${d+1} / ${DAYS}`;
  const isLast=d===DAYS-1;
  // LEFT
  makeLDay(d,pkgs);
  setTimeout(()=>{
    makeTruck(`lt${d}`,pkgs,'l');
    L.t++;L.co2+=CO2_TRUCK;L.cost+=COST_TRUCK;
    liveL.routes.push(L.t);liveL.co2.push(L.co2);liveL.cost.push(L.cost);
    animNum('lt',L.t);animNum('lc',L.co2,' kg');
    scrollB('lscroll');updateStreak();
    if(document.getElementById('page-biz').classList.contains('active'))refreshBizCharts();
  },300);
  // RIGHT
  makeRDay(d,pkgs);
  R.pending+=pkgs;
  setTimeout(()=>{
    addDots(d,pkgs);
    const fire=R.pending>=THRESHOLD||isLast;
    if(fire){
      const batch=R.pending;const nT=Math.ceil(batch/TRUCK_CAP);R.pending=0;
      setTimeout(()=>{
        clearDots();
        const lbl=document.getElementById(`rpl${d}`);if(lbl)lbl.textContent=`ğŸš€ Enviando ${batch} paquetes juntos`;
        for(let t=0;t<nT;t++){const cnt=t<nT-1?TRUCK_CAP:batch-t*TRUCK_CAP;setTimeout(()=>{
          makeTruck(`rt${d}`,cnt,'r');
          R.t++;R.co2+=CO2_TRUCK;R.cost+=COST_TRUCK;
          // pad live arrays to same length as L
          while(liveR.routes.length<liveL.routes.length-1){liveR.routes.push(R.t);liveR.co2.push(R.co2);liveR.cost.push(R.cost);}
          liveR.routes.push(R.t);liveR.co2.push(R.co2);liveR.cost.push(R.cost);
          animNum('rt',R.t);animNum('rc',R.co2,' kg');
          updateStreak();
          if(document.getElementById('page-biz').classList.contains('active'))refreshBizCharts();
        },t*320);}
        scrollB('rscroll');
        if(isLast)setTimeout(showFinal,nT*320+1200);
      },600);
    } else {
      const lbl=document.getElementById(`rpl${d}`);if(lbl)lbl.textContent=`â³ Acumulandoâ€¦ ${R.pending} en cola`;
      // pad right with current value
      liveR.routes.push(R.t);liveR.co2.push(R.co2);liveR.cost.push(R.cost);
      scrollB('rscroll');
      if(isLast)setTimeout(showFinal,1200);
    }
  },500);
}

function showFinal(){
  const sT=L.t-R.t,sCO2=L.co2-R.co2,pct=Math.round(sCO2/L.co2*100);
  document.getElementById('fn1').textContent=sT;
  document.getElementById('fn1s').textContent=`âˆ’${Math.round(sT/L.t*100)}% de rutas en la calle`;
  document.getElementById('fn2').textContent=sCO2+' kg';
  document.getElementById('fn2s').textContent=`de ${L.co2} kg sin EnvÃ­oEco`;
  document.getElementById('fn3').textContent=pct+'%';
  const trees=Math.round(sCO2/21),km=Math.round(sCO2/0.12);
  document.getElementById('fequiv').innerHTML=`<strong>${sCO2} kg COâ‚‚ evitados</strong> = plantar <strong>${trees} Ã¡rboles</strong> o no conducir <strong>${km.toLocaleString('es-ES')} km</strong> â€” solo en una semana y una zona.`;
  document.getElementById('streak').classList.remove('show');
  document.getElementById('fover').classList.add('show');
}

function startSim(){
  if(running)return;running=true;
  document.getElementById('bplay').disabled=true;
  function next(){if(curDay>=DAYS)return;stepDay(curDay++);if(curDay<DAYS)timer=setTimeout(next,STEP_MS);}
  next();
}
function resetSim(){
  clearTimeout(timer);running=false;curDay=0;
  L.t=0;L.co2=0;L.cost=0;R.t=0;R.co2=0;R.cost=0;R.pending=0;R.dots=[];
  liveL.routes.length=0;liveL.co2.length=0;liveL.cost.length=0;
  liveR.routes.length=0;liveR.co2.length=0;liveR.cost.length=0;
  document.getElementById('lscroll').innerHTML='';
  document.getElementById('rscroll').innerHTML='';
  document.getElementById('bplay').disabled=false;
  document.getElementById('dpill').textContent='DÃA 0 / 7';
  document.getElementById('streak').classList.remove('show');
  document.getElementById('fover').classList.remove('show');
  ['lt','rt'].forEach(id=>document.getElementById(id).textContent='0');
  ['lc','rc'].forEach(id=>document.getElementById(id).textContent='0 kg');
  buildBizPage('week');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(t){
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.querySelector(`.${t}-tab`).classList.add('active');
  document.getElementById(`page-${t}`).classList.add('active');
  if(t==='biz') buildBizPage(currentScenario);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUSINESS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentScenario='week';
let charts={};

// â”€â”€ Build SCENARIOS from real dashboard-stats.js data (con histÃ³rico) â”€â”€
const _wk=DASHBOARD_STATS;
const _wkDays=7;
const _wkCo2L=_wk.graficos.emisionesDiarias.acumuladoActual.slice(-1)[0]; // 84
const _wkCo2R=_wk.graficos.emisionesDiarias.acumuladoEco.slice(-1)[0];    // 36
const _wkCostL=_wk.kpis.costeActual;  // 420
const _wkCostR=_wk.kpis.costeEco;     // 163.8

// Proyecciones reales del algoritmo
const _hM=_wk.historicoProyecciones.find(h=>h.periodo==='1 Mes');
const _hY=_wk.historicoProyecciones.find(h=>h.periodo==='1 AÃ±o');

// Mes: coste total derivado del ritmo diario real + ahorro real del algoritmo
const _mCostL=Math.round((_wkCostL/_wkDays)*_hM.dias);          // 1800
const _mCostR=Math.round(_mCostL-_hM.ahorroEuros);               // 702
const _mCo2L =Math.round((_wkCo2L/_wkDays)*_hM.dias);           // 360
const _mCo2R =Math.round(_mCo2L-_hM.co2EvitadoKg);              // 206
const _mRoutesL=Math.round((_wk.graficos.rutasLanzadas.sinEco/_wkDays)*_hM.dias); // 30
const _mRoutesR=Math.round((_wk.graficos.rutasLanzadas.conEco/_wkDays)*_hM.dias); // 13

// AÃ±o: Ã­dem con datos reales anuales del algoritmo
const _yCostL=Math.round((_wkCostL/_wkDays)*_hY.dias);           // 21900
const _yCostR=Math.round(_yCostL-_hY.ahorroEuros);               // 8895
const _yCo2L =Math.round((_wkCo2L/_wkDays)*_hY.dias);           // 4380
const _yCo2R =Math.round(_yCo2L-_hY.co2EvitadoKg);              // 2393
const _yRoutesL=Math.round((_wk.graficos.rutasLanzadas.sinEco/_wkDays)*_hY.dias); // 365
const _yRoutesR=Math.round((_wk.graficos.rutasLanzadas.conEco/_wkDays)*_hY.dias); // 157

const SCENARIOS={
  week:{
    label:'1 semana Â· 1 zona', mult:1,
    paquetes:_wk.historicoProyecciones.find(h=>h.periodo==='1 Semana').paquetesOptimizados,
    routesL:_wk.graficos.rutasLanzadas.sinEco,
    routesR:_wk.graficos.rutasLanzadas.conEco,
    co2L:_wkCo2L, co2R:_wkCo2R,
    costL:_wkCostL, costR:_wkCostR,
    fillL:_wk.kpis.porcentajeOcupacionSinEco,
    fillR:_wk.kpis.porcentajeOcupacionConEco,
    days:_wk.graficos.emisionesDiarias.dias,
    co2ByDayL:_wk.graficos.emisionesDiarias.acumuladoActual,
    co2ByDayR:_wk.graficos.emisionesDiarias.acumuladoEco,
    costByDayL:_wk.graficos.costeDiario.acumuladoActual,
    costByDayR:_wk.graficos.costeDiario.acumuladoEco,
  },
  month:{
    label:'1 mes Â· 1 zona', mult:_hM.dias/_wkDays,
    paquetes:_hM.paquetesOptimizados,
    routesL:_mRoutesL, routesR:_mRoutesR,
    co2L:_mCo2L, co2R:_mCo2R,
    costL:_mCostL, costR:_mCostR,
    fillL:_wk.kpis.porcentajeOcupacionSinEco,
    fillR:_wk.kpis.porcentajeOcupacionConEco,
    days:['S1','S2','S3','S4'],
    co2ByDayL:[_mCo2L/4,_mCo2L/2,_mCo2L*3/4,_mCo2L].map(Math.round),
    co2ByDayR:[_mCo2R/4,_mCo2R/2,_mCo2R*3/4,_mCo2R].map(Math.round),
    costByDayL:[_mCostL/4,_mCostL/2,_mCostL*3/4,_mCostL].map(Math.round),
    costByDayR:[_mCostR/4,_mCostR/2,_mCostR*3/4,_mCostR].map(Math.round),
  },
  year:{
    label:'1 aÃ±o Â· 1 zona', mult:_hY.dias/_wkDays,
    paquetes:_hY.paquetesOptimizados,
    routesL:_yRoutesL, routesR:_yRoutesR,
    co2L:_yCo2L, co2R:_yCo2R,
    costL:_yCostL, costR:_yCostR,
    fillL:_wk.kpis.porcentajeOcupacionSinEco,
    fillR:_wk.kpis.porcentajeOcupacionConEco,
    days:['T1','T2','T3','T4'],
    co2ByDayL:[_yCo2L/4,_yCo2L/2,_yCo2L*3/4,_yCo2L].map(Math.round),
    co2ByDayR:[_yCo2R/4,_yCo2R/2,_yCo2R*3/4,_yCo2R].map(Math.round),
    costByDayL:[_yCostL/4,_yCostL/2,_yCostL*3/4,_yCostL].map(Math.round),
    costByDayR:[_yCostR/4,_yCostR/2,_yCostR*3/4,_yCostR].map(Math.round),
  }
};

function fmt(n){
  if(n>=1000000)return(n/1000000).toFixed(1)+'M';
  if(n>=1000)return(n/1000).toFixed(0)+'K';
  return n.toString();
}

function setScenario(key,btn){
  currentScenario=key;
  document.querySelectorAll('.scen-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  buildBizPage(key);
}

function buildBizPage(key){
  const s=SCENARIOS[key];
  const saving=s.costL-s.costR;
  const savingPct=Math.round((saving/s.costL)*100);
  const co2Saved=s.co2L-s.co2R;
  const co2Pct=Math.round((co2Saved/s.co2L)*100);

  // KPIs
  document.getElementById('kpi-cost-before').textContent=fmt(s.costL)+'â‚¬';
  document.getElementById('kpi-cost-before-sub').textContent=`${fmt(s.routesL)} rutas Ã— 60â‚¬`;
  document.getElementById('kpi-cost-after').textContent=fmt(s.costR)+'â‚¬';
  document.getElementById('kpi-cost-after-sub').textContent=`${fmt(s.routesR)} rutas Ã— 60â‚¬`;
  document.getElementById('kpi-cost-delta').textContent=`â–¼ âˆ’${savingPct}% de coste`;
  document.getElementById('kpi-saving').textContent=fmt(saving)+'â‚¬';
  document.getElementById('kpi-saving-sub').textContent=`${s.label} Â· ${s.paquetes} paquetes optimizados`;
  document.getElementById('kpi-co2').textContent=fmt(co2Saved)+' kg';
  document.getElementById('kpi-co2-sub').textContent=`â‰ˆ ${co2Pct}% menos emisiones`;
  document.getElementById('kpi-fill').textContent=s.fillR+'%';
  document.getElementById('kpi-fill-sub').textContent=`vs ${s.fillL}% sin algoritmo`;

  // ROI table â€” real data for week, scaled for month/year
  const _roi=DASHBOARD_STATS.tablaRoi;
  const zones=_roi.map(z=>({
    zona:z.zona,
    rAh:z.rutasAhorradas*s.mult,
    eur:z.ahorroEuros*s.mult,
    co2:Math.abs(z.co2Evitado)*s.mult,
    roi:z.roi
  }));

  document.getElementById('roi-tbody').innerHTML=zones.map(z=>`
    <tr>
      <td>${z.zona}</td>
      <td class="${z.roi==='Alto'?'good':'neutral'}">${fmt(z.rAh)} menos</td>
      <td class="good">+${fmt(z.eur)}â‚¬</td>
      <td class="good">âˆ’${fmt(z.co2)} kg</td>
      <td class="${z.roi==='Alto'?'good':'neutral'}">${z.roi==='Alto'?'â­ Alto':'âœ“ Medio'}</td>
    </tr>`).join('');

  drawCharts(s);
}

function refreshBizCharts(){
  // Update with live sim data if on biz page and sim has run some days
  if(!liveL.routes.length) return;
  const s=SCENARIOS['week'];
  // override co2 and cost series with live data
  const liveSc={...s,
    co2ByDayL:liveL.co2,co2ByDayR:liveR.co2,
    costByDayL:liveL.cost,costByDayR:liveR.cost,
    days:DAY_NAMES.slice(0,liveL.co2.length).map(d=>d.split(' ')[0]),
    routesL:L.t,routesR:R.t,co2L:L.co2,co2R:R.co2,costL:L.cost,costR:R.cost,
  };
  drawCharts(liveSc);
}

const CHART_DEFAULTS={
  plugins:{legend:{labels:{color:'#555',font:{family:'DM Sans',size:10}}}},
  scales:{
    x:{grid:{color:'#e0e0e0'},ticks:{color:'#777',font:{size:9}}},
    y:{grid:{color:'#e0e0e0'},ticks:{color:'#777',font:{size:9}}}
  }
};

function destroyChart(key){if(charts[key]){charts[key].destroy();delete charts[key];}}

function drawCharts(s){
  // 1. BAR: routes
  destroyChart('routes');
  charts['routes']=new Chart(document.getElementById('ch-routes'),{
    type:'bar',
    data:{
      labels:['Sin EnvÃ­oEco','Con EnvÃ­oEco'],
      datasets:[{
        label:'Rutas',
        data:[s.routesL,s.routesR],
        backgroundColor:['rgba(212,5,17,.75)','rgba(76,175,80,.75)'],
        borderColor:['#D40511','#4caf50'],
        borderWidth:2,borderRadius:6,
      }]
    },
    options:{...CHART_DEFAULTS,responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`${ctx.raw} rutas lanzadas`}}
      }
    }
  });

  // 2. LINE: CO2 acumulado dÃ­a a dÃ­a
  destroyChart('co2line');
  const labels2=s.days;
  charts['co2line']=new Chart(document.getElementById('ch-co2line'),{
    type:'line',
    data:{
      labels:labels2,
      datasets:[
        {label:'Actual',data:s.co2ByDayL,borderColor:'#D40511',backgroundColor:'rgba(212,5,17,.08)',tension:.4,pointRadius:3,fill:true},
        {label:'EnvÃ­oEco',data:s.co2ByDayR,borderColor:'#4caf50',backgroundColor:'rgba(76,175,80,.1)',tension:.4,pointRadius:3,fill:true},
      ]
    },
    options:{...CHART_DEFAULTS,responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#555',font:{size:10}}}}
    }
  });

  // 3. PIE: cost breakdown
  destroyChart('pie');
  const saving=s.costL-s.costR;
  charts['pie']=new Chart(document.getElementById('ch-pie'),{
    type:'doughnut',
    data:{
      labels:['Coste evitado (ahorro)','Coste necesario (EnvÃ­oEco)'],
      datasets:[{
        data:[saving,s.costR],
        backgroundColor:['rgba(76,175,80,.8)','rgba(255,204,0,.7)'],
        borderColor:['#4caf50','#FFCC00'],
        borderWidth:2,hoverOffset:6,
      }]
    },
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',
      plugins:{
        legend:{position:'bottom',labels:{color:'#555',font:{size:9},boxWidth:10}},
        tooltip:{callbacks:{label:ctx=>`${fmt(ctx.raw)}â‚¬ (${Math.round(ctx.raw/s.costL*100)}%)`}}
      }
    }
  });

  // 4. LINE: coste acumulado
  destroyChart('cost');
  charts['cost']=new Chart(document.getElementById('ch-cost'),{
    type:'line',
    data:{
      labels:s.days,
      datasets:[
        {label:'Actual',data:s.costByDayL,borderColor:'#D40511',backgroundColor:'rgba(212,5,17,.07)',tension:.4,pointRadius:3,fill:true},
        {label:'EnvÃ­oEco',data:s.costByDayR,borderColor:'#4caf50',backgroundColor:'rgba(76,175,80,.08)',tension:.4,pointRadius:3,fill:true},
      ]
    },
    options:{...CHART_DEFAULTS,responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#555',font:{size:10}}},
        tooltip:{callbacks:{label:ctx=>`${fmt(ctx.raw)}â‚¬`}}
      }
    }
  });
}

// Init biz page on load
buildBizPage('week');
</script>
</body>
</html>