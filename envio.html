<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalle de env√≠o</title>
    <link rel="stylesheet" href="styles-envio.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <style>
        /* Estilos espec√≠ficos de esta vista */
        .container {
            max-width: 960px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .shipment-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .08);
            padding: 24px;
            display: grid;
            gap: 16px;
        }

        .shipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px 16px;
        }

        .badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .3px;
            background: #ffe680;
            color: #7a5a00;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .field {
            background: #fafafa;
            border-radius: 8px;
            padding: 12px 14px;
        }

        .field label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-bottom: 6px;
        }

        .field div {
            font-size: 16px;
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #d40511;
            color: #d40511;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all .2s ease;
        }

        .btn-outline:hover {
            background: #ffd6d8;
        }

        .note {
            font-size: 13px;
            color: #444;
            background: #fff9d6;
            border: 1px solid #ffe58f;
            padding: 10px 12px;
            border-radius: 6px;
        }


        /* ‚îÄ‚îÄ Eco options panel ‚îÄ‚îÄ */
        .eco-panel {
            display: none;
            margin-top: 16px;
            background: #f0faf0;
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 22px 24px;
            animation: slideDown .25s ease;
        }
        @keyframes slideDown {
            from { opacity:0; transform:translateY(-8px); }
            to   { opacity:1; transform:translateY(0); }
        }
        .eco-panel h3 {
            margin: 0 0 4px;
            font-size: 17px;
            color: #1b5e20;
        }
        .eco-panel p.eco-intro {
            margin: 0 0 18px;
            font-size: 13px;
            color: #555;
        }

        /* ‚îÄ‚îÄ Section headings inside panel ‚îÄ‚îÄ */
        .eco-section-title {
            font-size: 11px;
            font-weight: 800;
            letter-spacing: .6px;
            text-transform: uppercase;
            color: #2e7d32;
            margin: 0 0 10px;
        }
        .eco-divider {
            border: none;
            border-top: 1px solid #c8e6c9;
            margin: 16px 0;
        }

        /* ‚îÄ‚îÄ Location list picker ‚îÄ‚îÄ */
        .loc-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .loc-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all .16s ease;
        }
        .loc-row:hover { border-color: #4caf50; background: #f4fbf4; }
        .loc-row.selected {
            border-color: #2e7d32;
            background: #e8f5e9;
            box-shadow: 0 0 0 3px rgba(46,125,50,.12);
        }
        .loc-row.no-eco {
            border-color: #e0e0e0;
        }
        .loc-row.no-eco:hover { border-color: #bbb; background: #fafafa; }
        .loc-row.no-eco.selected {
            border-color: #999;
            background: #f5f5f5;
            box-shadow: 0 0 0 3px rgba(0,0,0,.06);
        }
        .loc-row-icon {
            font-size: 22px;
            flex-shrink: 0;
            width: 32px;
            text-align: center;
        }
        .loc-row-info { flex: 1; min-width: 0; }
        .loc-row-name {
            font-size: 13px;
            font-weight: 700;
            color: #1a1a1a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .loc-row-addr {
            font-size: 11px;
            color: #777;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .loc-row-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .loc-type-badge {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: .3px;
            text-transform: uppercase;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1px 6px;
        }
        .loc-pts-pill {
            font-size: 11px;
            font-weight: 800;
            padding: 2px 10px;
            border-radius: 20px;
            background: #e0e0e0;
            color: #666;
        }
        .loc-pts-pill.green { background: #c8e6c9; color: #1b5e20; }
        .loc-pts-pill.best  { background: #2e7d32; color: #fff; }
        .loc-pts-pill.none  { background: #f0f0f0; color: #aaa; }

        /* ‚îÄ‚îÄ No-eco notice ‚îÄ‚îÄ */
        .no-eco-notice {
            display: none;
            align-items: center;
            gap: 10px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            color: #7a5a00;
            margin-bottom: 0;
        }
        .no-eco-notice.visible { display: flex; }

        /* ‚îÄ‚îÄ Date options (greyed when no-eco location) ‚îÄ‚îÄ */
        .date-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            transition: opacity .2s;
        }
        .date-options.disabled {
            opacity: .35;
            pointer-events: none;
        }
        .date-opt {
            cursor: pointer;
            border: 2px solid #c8e6c9;
            background: #fff;
            border-radius: 10px;
            padding: 12px 8px 10px;
            text-align: center;
            transition: all .18s ease;
            position: relative;
        }
        .date-opt:hover { border-color: #4caf50; background: #f1f8f1; }
        .date-opt.selected {
            border-color: #2e7d32;
            background: #e8f5e9;
            box-shadow: 0 0 0 3px rgba(46,125,50,.15);
        }
        .date-opt .dopt-day   { font-size: 12px; font-weight: 800; color: #1a1a1a; }
        .date-opt .dopt-date  { font-size: 10px; color: #666; margin: 2px 0 6px; }
        .date-opt .dopt-delay { font-size: 10px; color: #888; margin-bottom: 8px; }
        .date-opt .dopt-pts {
            display: inline-block;
            background: #2e7d32;
            color: #fff;
            font-size: 11px;
            font-weight: 800;
            padding: 3px 10px;
            border-radius: 20px;
            transition: background .2s;
        }
        /* Best combination highlight */
        .date-opt.best-combo {
            border-color: #ff8f00;
            background: #fff8e1;
        }
        .date-opt.best-combo.selected {
            border-color: #ff8f00;
            background: #fff3cd;
            box-shadow: 0 0 0 3px rgba(255,143,0,.2);
        }
        .date-opt.best-combo .dopt-pts { background: #ff8f00; }
        .best-tag {
            position: absolute;
            top: -1px; right: -1px;
            background: #ff8f00;
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 2px 7px;
            border-radius: 0 8px 0 8px;
            letter-spacing: .3px;
        }

        /* ‚îÄ‚îÄ Live EcoPoints bar ‚îÄ‚îÄ */
        .pts-live-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 12px 18px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .pts-live-breakdown {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .pli {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .pli-label {
            font-size: 9px;
            font-weight: 800;
            color: #aaa;
            letter-spacing: .5px;
            text-transform: uppercase;
        }
        .pli-val {
            font-size: 14px;
            font-weight: 800;
            color: #555;
            transition: color .2s;
        }
        .pli-val.active { color: #2e7d32; }
        .pts-live-sep { color: #ccc; font-size: 16px; }
        .pts-live-total {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .plt-label {
            font-size: 9px;
            font-weight: 800;
            color: #aaa;
            letter-spacing: .5px;
            text-transform: uppercase;
        }
        .plt-val {
            font-size: 28px;
            font-weight: 900;
            color: #bbb;
            line-height: 1;
            transition: color .25s, transform .2s;
        }
        .plt-val.has-value { color: #1b5e20; }
        .plt-val.bump { transform: scale(1.14); }

        /* ‚îÄ‚îÄ Confirm button ‚îÄ‚îÄ */
        .btn-confirm-eco {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: #fff;
            border: none;
            padding: 13px 26px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity .2s;
            width: 100%;
            margin-top: 14px;
        }
        .btn-confirm-eco:disabled { opacity: .38; cursor: default; }
        .btn-confirm-eco:not(:disabled):hover { opacity: .88; }

        /* ‚îÄ‚îÄ Confirm hint ‚îÄ‚îÄ */
        .eco-confirm-hint {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin: 6px 0 0;
        }
        .eco-confirm-hint.ready { color: #2e7d32; font-weight: 600; }

        /* ‚îÄ‚îÄ Activated message ‚îÄ‚îÄ */
        .eco-activated-msg {
            display: none;
            align-items: center;
            gap: 12px;
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 14px 18px;
            font-size: 14px;
            color: #1b5e20;
            font-weight: 600;
            flex-wrap: wrap;
            margin-top: 14px;
        }
        .eco-activated-msg.visible { display: flex; }
        .eco-activated-msg .pts-pill {
            background: #2e7d32;
            color: #fff;
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 15px;
            font-weight: 800;
            white-space: nowrap;
            margin-left: auto;
        }

        /* ‚îÄ‚îÄ Panel header row (title + radius slider) ‚îÄ‚îÄ */
        .eco-panel-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }
        .eco-panel-header > div:first-child { flex: 1; min-width: 0; }
        .radius-control {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
            min-width: 160px;
        }
        .radius-label {
            font-size: 10px;
            font-weight: 800;
            letter-spacing: .5px;
            text-transform: uppercase;
            color: #2e7d32;
            white-space: nowrap;
        }
        .radius-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .radius-val {
            font-size: 13px;
            font-weight: 900;
            color: #1b5e20;
            min-width: 44px;
            text-align: right;
            white-space: nowrap;
        }
        #radius-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 110px;
            height: 4px;
            border-radius: 4px;
            background: linear-gradient(to right, #4caf50 0%, #4caf50 var(--pct, 0%), #c8e6c9 var(--pct, 0%), #c8e6c9 100%);
            outline: none;
            cursor: pointer;
        }
        #radius-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2e7d32;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,.25);
            cursor: pointer;
        }
        #radius-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2e7d32;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,.25);
            cursor: pointer;
        }
        /* Hidden location rows (outside radius) */
        .loc-row.out-of-range {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <div><a href="index.html" style="text-decoration:none;"><strong class="logo">HackatonDHL</strong></a></div>
        <nav>
            <a href="index.html">Haga seguimiento</a>
            <a href="#">Enviar</a>
            <a href="#">Servicios de log√≠stica</a>
            <a href="#">Servicio al cliente</a>
        </nav>
        <a href="profile.html" class="header-profile">
            <span class="header-avatar">CM</span>
            <span class="header-username">Carlos M.</span>
        </a>
    </header>

    <main class="container">
        <h1 style="margin: 10px 0 18px;">Detalle del env√≠o</h1>
        <h2 style="margin-top:40px;">Ubicaci√≥n del env√≠o</h2>
        <div id="map"></div>

        <section class="shipment-card" id="card">
            <div class="shipment-header">
                <div>
                    <div style="font-size:18px; font-weight:800;">Env√≠o #1234 5678 90</div>
                    <span class="badge" id="badge-servicio">Servicio: Est√°ndar</span>
                </div>
                <div class="actions">
                    <button class="btn-outline" id="btn-eco">üçÉ Cambiar a Env√≠oEco</button>
                    <a class="btn" href="index.html">Volver</a>
                </div>
            </div>

            <!-- ECO OPTIONS PANEL (hidden until button click) -->
            <div class="eco-panel" id="eco-panel">

                <!-- Panel header: title + radius slider -->
                <div class="eco-panel-header">
                    <div>
                        <h3>üåø Configura tu Env√≠oEco</h3>
                        <p class="eco-intro" style="margin-bottom:0">Elige ubicaci√≥n y fecha ‚Äî los puntos se calculan instant√°neamente con cada combinaci√≥n.</p>
                    </div>
                    <div class="radius-control">
                        <span class="radius-label">üìç Radio de b√∫squeda</span>
                        <div class="radius-row">
                            <input type="range" id="radius-slider" min="1" max="10" value="3" step="0.5"
                                oninput="onRadiusChange(this)">
                            <span class="radius-val" id="radius-val">3 km</span>
                        </div>
                    </div>
                </div>

                <!-- LOCATION ROW -->
                <p class="eco-section-title">üìç Selecciona un punto de recogida</p>
                <div class="loc-list" id="loc-list">

                    <div class="loc-row no-eco" data-loc-bonus="0" data-eco="false" data-dist="0" data-loc-label="Tu casa (C/ Portillo, 42)" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üè†</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Tu casa</div>
                            <div class="loc-row-addr">C/ Portillo, 42 ‚Äì Piso 3¬∫ B</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Domicilio</span>
                            <span class="loc-pts-pill none">Sin EcoPoints</span>
                        </div>
                    </div>

                    <div class="loc-row" data-loc-bonus="60" data-eco="true" data-dist="0.8" data-loc-label="Correos ‚Äì C/ Legan√©s, 3" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üì®</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Correos</div>
                            <div class="loc-row-addr">C/ Legan√©s, 3</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Oficina postal</span>
                            <span class="loc-pts-pill green">hasta +400 pts</span>
                        </div>
                    </div>

                    <div class="loc-row" data-loc-bonus="60" data-eco="true" data-dist="1.5" data-loc-label="Lotter√≠as ‚Äì C/ Murcia, 17" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üé´</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Lotter√≠as y apuestas</div>
                            <div class="loc-row-addr">C/ Murcia, 17</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Estanquillo</span>
                            <span class="loc-pts-pill green">hasta +400 pts</span>
                        </div>
                    </div>

                    <div class="loc-row" data-loc-bonus="80" data-eco="true" data-dist="2.3" data-loc-label="Supermercado D√≠a ‚Äì C/ Real, 8" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üõí</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Supermercado D√≠a</div>
                            <div class="loc-row-addr">C/ Real, 8</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Supermercado</span>
                            <span class="loc-pts-pill green">hasta +420 pts</span>
                        </div>
                    </div>

                    <div class="loc-row" data-loc-bonus="80" data-eco="true" data-dist="3.7" data-loc-label="Farmacia Central ‚Äì Av. Constituci√≥n, 5" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üíä</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Farmacia Central</div>
                            <div class="loc-row-addr">Av. Constituci√≥n, 5</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Farmacia</span>
                            <span class="loc-pts-pill green">hasta +420 pts</span>
                        </div>
                    </div>

                    <div class="loc-row" data-loc-bonus="120" data-eco="true" data-dist="5.2" data-loc-label="Casillero DHL ‚Äì Estaci√≥n Atocha" onclick="selectLocation(this)">
                        <div class="loc-row-icon">üì¶</div>
                        <div class="loc-row-info">
                            <div class="loc-row-name">Casillero DHL</div>
                            <div class="loc-row-addr">Estaci√≥n Atocha ‚Äì Planta baja</div>
                        </div>
                        <div class="loc-row-right">
                            <span class="loc-type-badge">Casillero 24 h</span>
                            <span class="loc-pts-pill best">‚≠ê hasta +460 pts</span>
                        </div>
                    </div>

                </div>

                <hr class="eco-divider">

                <!-- DATE ROW -->
                <p class="eco-section-title">üìÖ ¬øCu√°ndo puedes recibirlo?</p>
                <!-- No-eco notice (shown when home is selected) -->
                <div class="no-eco-notice" id="no-eco-notice">
                    <span style="font-size:18px">‚ö†Ô∏è</span>
                    <span>La entrega a <strong>domicilio</strong> no genera EcoPoints: no permite agrupar paquetes. Elige otro punto de recogida para ganar puntos.</span>
                </div>
                <div class="date-options" id="date-options">
                    <!-- built by JS -->
                </div>

                <hr class="eco-divider">

                <!-- LIVE ECOPOINTS BAR -->
                <div class="pts-live-bar">
                    <div class="pts-live-breakdown">
                        <div class="pli">
                            <span class="pli-label">Por ubicaci√≥n</span>
                            <span class="pli-val" id="pli-loc">‚Äî</span>
                        </div>
                        <span class="pts-live-sep">+</span>
                        <div class="pli">
                            <span class="pli-label">Por fecha</span>
                            <span class="pli-val" id="pli-date">‚Äî</span>
                        </div>
                        <span class="pts-live-sep">=</span>
                    </div>
                    <div class="pts-live-total">
                        <span class="plt-label">Total EcoPoints</span>
                        <span class="plt-val" id="plt-val">‚Äî</span>
                    </div>
                </div>

                <button class="btn-confirm-eco" id="btn-confirm" disabled onclick="confirmEco()">Confirmar Env√≠oEco</button>
                <p class="eco-confirm-hint" id="eco-confirm-hint">Selecciona una ubicaci√≥n y una fecha para continuar</p>

                <!-- Post-confirmation message -->
                <div class="eco-activated-msg" id="eco-activated">
                    <div>
                        <div>‚úÖ Env√≠oEco activado</div>
                        <div style="font-size:13px;font-weight:400;margin-top:3px;">Entrega el <strong id="activated-date">‚Äî</strong> ¬∑ <span id="activated-loc-label">‚Äî</span></div>
                    </div>
                    <span class="pts-pill" id="activated-pts">‚Äî</span>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Estado</label>
                    <div id="estado">En tr√°nsito</div>
                </div>
                <div class="field">
                    <label>Entrega estimada</label>
                    <div>Martes 25 de febrero, 12:00‚Äì16:00</div>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label>Origen</label>
                    <div>Madrid, ES</div>
                </div>
                <div class="field">
                    <label>Destino</label>
                    <div>Barcelona, ES</div>
                </div>
            </div>

            <p class="note" id="nota">
                Este env√≠o usa el servicio Est√°ndar. Puedes cambiar a <strong>Env√≠oEco</strong> para reducir tu huella
                de carbono.
            </p>
        </section>
        <section class="impact-section" aria-labelledby="impact-title">
            <h2 id="impact-title">Impacto ambiental del env√≠o</h2>

            <div class="impact-summary">
                <div class="impact-item">
                    <span class="label">Emisiones estimadas</span>
                    <span class="value"><span id="co2-value">4.8</span> kg CO‚ÇÇe</span>
                </div>
                <div class="impact-item">
                    <span class="label">Ahorro con Env√≠oEco</span>
                    <span class="value saving">hasta <span id="saving-percent">40</span>%</span>
                </div>
            </div>

            <!-- Barra de progreso accesible -->
            <div class="impact-bar" role="progressbar" aria-valuemin="0" aria-valuemax="10" aria-valuenow="4.8"
                aria-label="Emisiones de CO2 del env√≠o">
                <div class="impact-bar__fill" id="impact-fill" style="width: 48%"></div>
            </div>

            <p class="impact-note" id="impact-note">
                Este env√≠o usa el servicio <strong>Est√°ndar</strong>. Cambia a <strong>Env√≠oEco</strong> para reducir
                las emisiones de CO‚ÇÇe.
            </p>
        </section>
    </main>

    <script>
        // ‚îÄ‚îÄ Panel toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const btnEcoBtn = document.getElementById('btn-eco');
        const ecoPanel  = document.getElementById('eco-panel');
        btnEcoBtn.addEventListener('click', () => {
            if (btnEcoBtn.disabled) return;
            const isOpen = ecoPanel.style.display === 'block';
            ecoPanel.style.display = isOpen ? 'none' : 'block';
        });

        // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let selectedLocBonus = null;
        let selectedLocLabel = null;
        let selectedLocEco   = null; // false = home delivery, no date pts
        let selectedDays     = null;
        let selectedDatePts  = null;

        const baseDelivery = new Date(2026, 1, 25); // Tue 25 Feb 2026

        const DATE_SLOTS = [
            { days: 2, pts: 80  },
            { days: 3, pts: 120 },
            { days: 5, pts: 200 },
            { days: 7, pts: 340 },
        ];
        const DAYS_ES   = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
        const MONTHS_ES = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];

        function fmtLong(d) {
            const s = d.toLocaleDateString('es-ES', { weekday:'long', day:'numeric', month:'long' });
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // ‚îÄ‚îÄ Build date cards on load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function buildDateCards() {
            const container  = document.getElementById('date-options');
            const noEco      = selectedLocEco === false;
            const locBonus   = (!noEco && selectedLocBonus !== null) ? selectedLocBonus : 0;
            const maxTotal   = Math.max(...DATE_SLOTS.map(s => s.pts + locBonus));

            container.innerHTML = '';
            container.classList.toggle('disabled', noEco);

            DATE_SLOTS.forEach(slot => {
                const d     = new Date(baseDelivery);
                d.setDate(d.getDate() + slot.days);
                const total      = noEco ? 0 : slot.pts + locBonus;
                const isBest     = !noEco && (total === maxTotal);
                const wasSelected = (selectedDays === slot.days);

                const div = document.createElement('div');
                div.className = 'date-opt' + (isBest ? ' best-combo' : '') + (wasSelected && !noEco ? ' selected' : '');
                div.dataset.days    = slot.days;
                div.dataset.datePts = noEco ? 0 : slot.pts;
                div.innerHTML = (isBest ? '<span class="best-tag">‚≠ê M√°ximo</span>' : '') + `
                    <div class="dopt-day">${DAYS_ES[d.getDay()]}</div>
                    <div class="dopt-date">${d.getDate()} ${MONTHS_ES[d.getMonth()]}</div>
                    <div class="dopt-delay">retraso +${slot.days} d√≠as</div>
                    <span class="dopt-pts" style="${noEco ? 'background:#ccc;color:#888' : ''}">${noEco ? '0 pts' : '+' + total + ' pts'}</span>
                `;
                if (!noEco) div.addEventListener('click', () => selectDate(div));
                container.appendChild(div);
            });
        }

        // initial build (no location selected yet)
        buildDateCards();

        // ‚îÄ‚îÄ Radius slider ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function onRadiusChange(slider) {
            const km  = parseFloat(slider.value);
            const pct = ((km - 1) / (10 - 1)) * 100;
            slider.style.setProperty('--pct', pct + '%');
            document.getElementById('radius-val').textContent = km % 1 === 0 ? km + ' km' : km.toFixed(1) + ' km';
            filterByRadius(km);
        }

        function filterByRadius(km) {
            document.querySelectorAll('.loc-row').forEach(row => {
                const dist = parseFloat(row.dataset.dist);
                // Tu casa (dist=0) always visible
                const inRange = dist === 0 || dist <= km;
                row.classList.toggle('out-of-range', !inRange);
                // If the selected row goes out of range, deselect it
                if (!inRange && row.classList.contains('selected')) {
                    row.classList.remove('selected');
                    selectedLocBonus = null;
                    selectedLocLabel = null;
                    selectedLocEco   = null;
                    selectedDays     = null;
                    selectedDatePts  = null;
                    document.getElementById('pli-loc').textContent = '‚Äî';
                    document.getElementById('pli-loc').classList.remove('active');
                    document.getElementById('pli-date').textContent = '‚Äî';
                    document.getElementById('pli-date').classList.remove('active');
                    document.getElementById('no-eco-notice').classList.remove('visible');
                    buildDateCards();
                    updateLiveTotal();
                }
            });
        }

        // Apply initial radius on load
        (function() {
            const slider = document.getElementById('radius-slider');
            const initKm = parseFloat(slider.value);
            const pct    = ((initKm - 1) / (10 - 1)) * 100;
            slider.style.setProperty('--pct', pct + '%');
            filterByRadius(initKm);
        })();

        // ‚îÄ‚îÄ Set max-pts labels on location rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const MAX_DATE_PTS = Math.max(...DATE_SLOTS.map(s => s.pts));
        document.querySelectorAll('.loc-row[data-eco="true"]').forEach(row => {
            const bonus = parseInt(row.dataset.locBonus);
            const pill  = row.querySelector('.loc-pts-pill');
            if (pill) {
                const isBest = bonus === Math.max(...[
                    ...document.querySelectorAll('.loc-row[data-eco="true"]')
                ].map(r => parseInt(r.dataset.locBonus)));
                pill.textContent = (isBest ? '‚≠ê ' : '') + 'hasta +' + (bonus + MAX_DATE_PTS) + ' pts';
            }
        });

        // ‚îÄ‚îÄ Location selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function selectLocation(el) {
            document.querySelectorAll('.loc-row').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedLocBonus = parseInt(el.dataset.locBonus);
            selectedLocLabel = el.dataset.locLabel;
            selectedLocEco   = el.dataset.eco !== 'false';

            const noEco   = !selectedLocEco;
            const notice  = document.getElementById('no-eco-notice');
            notice.classList.toggle('visible', noEco);

            // Reset date when location changes
            if (noEco) {
                selectedDays = null; selectedDatePts = null;
            }

            // Rebuild date cards
            buildDateCards();

            // Re-attach selected date if still valid
            if (!noEco && selectedDays !== null) {
                document.querySelectorAll('.date-opt').forEach(o => {
                    if (parseInt(o.dataset.days) === selectedDays) o.classList.add('selected');
                });
            }

            // Update live bar
            const locEl = document.getElementById('pli-loc');
            locEl.textContent = noEco ? '0 pts' : '+' + selectedLocBonus + ' pts';
            locEl.classList.toggle('active', !noEco);

            if (noEco) {
                document.getElementById('pli-date').textContent = '‚Äî';
                document.getElementById('pli-date').classList.remove('active');
            }
            updateLiveTotal();
        }

        // ‚îÄ‚îÄ Date selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function selectDate(el) {
            document.querySelectorAll('.date-opt').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedDays    = parseInt(el.dataset.days);
            selectedDatePts = parseInt(el.dataset.datePts);

            const dateEl = document.getElementById('pli-date');
            dateEl.textContent = '+' + selectedDatePts + ' pts';
            dateEl.classList.add('active');
            updateLiveTotal();
        }

        // ‚îÄ‚îÄ Live total update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateLiveTotal() {
            const noEco     = selectedLocEco === false;
            const bothReady = !noEco && selectedLocBonus !== null && selectedDays !== null;
            const pltEl     = document.getElementById('plt-val');
            const hint      = document.getElementById('eco-confirm-hint');
            const btn       = document.getElementById('btn-confirm');

            if (noEco) {
                pltEl.textContent = '0 pts';
                pltEl.classList.remove('has-value');
                hint.textContent = 'Esta ubicaci√≥n no genera EcoPoints. Selecciona otro punto.';
                hint.classList.remove('ready');
                btn.disabled = true;
            } else if (bothReady) {
                const total = selectedDatePts + selectedLocBonus;
                pltEl.textContent = '+' + total + ' pts';
                pltEl.classList.add('has-value');
                pltEl.classList.add('bump');
                setTimeout(() => pltEl.classList.remove('bump'), 300);
                btn.disabled = false;
                hint.textContent = '¬°Listo! Pulsa Confirmar para activar Env√≠oEco';
                hint.classList.add('ready');
            } else if (selectedLocBonus !== null) {
                pltEl.textContent = '‚Äî';
                pltEl.classList.remove('has-value');
                hint.textContent = 'Ahora selecciona una fecha de entrega';
                hint.classList.remove('ready');
                btn.disabled = true;
            } else {
                pltEl.textContent = '‚Äî';
                pltEl.classList.remove('has-value');
                hint.textContent = 'Selecciona un punto de recogida y una fecha';
                hint.classList.remove('ready');
                btn.disabled = true;
            }
        }

        // ‚îÄ‚îÄ Confirm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function confirmEco() {
            const totalPts    = selectedDatePts + selectedLocBonus;
            const newDate     = new Date(baseDelivery);
            newDate.setDate(newDate.getDate() + selectedDays);
            const dateStrLong = fmtLong(newDate);

            // Lock UI
            document.querySelectorAll('.loc-row, .date-opt').forEach(o => {
                o.style.pointerEvents = 'none';
                o.style.opacity = '.5';
            });
            document.querySelectorAll('.loc-row.selected, .date-opt.selected').forEach(o => o.style.opacity = '1');
            document.getElementById('radius-slider').disabled = true;
            document.getElementById('btn-confirm').style.display = 'none';
            document.getElementById('eco-confirm-hint').style.display = 'none';

            // Show activation message
            document.getElementById('activated-date').textContent      = dateStrLong;
            document.getElementById('activated-loc-label').textContent = selectedLocLabel;
            document.getElementById('activated-pts').textContent       = `+${totalPts} üçÉ pts`;
            document.getElementById('eco-activated').classList.add('visible');

            // Update shipment card
            const badge    = document.getElementById('badge-servicio');
            const nota     = document.getElementById('nota');
            const estadoEl = document.getElementById('estado');
            if (badge)    { badge.textContent = 'Servicio: Env√≠oEco ‚ôª'; badge.style.background = '#d9f7be'; badge.style.color = '#135200'; }
            if (estadoEl) estadoEl.textContent = 'En tr√°nsito (modo ecol√≥gico)';
            if (nota)     nota.innerHTML = `Has activado <strong>Env√≠oEco</strong> con entrega en <strong>${selectedLocLabel}</strong> el <strong>${dateStrLong}</strong>. Ganar√°s <strong>+${totalPts} EcoPoints</strong> al completarse la entrega.`;

            if (window.__updateImpactBar) window.__updateImpactBar();

            btnEcoBtn.textContent   = '‚úÖ Env√≠oEco activado';
            btnEcoBtn.disabled      = true;
            btnEcoBtn.style.opacity = '.7';
            btnEcoBtn.style.cursor  = 'default';
        }
    </script>

</body>

</html>
<script>
    // Coordenadas de ejemplo (Madrid)
    const lat = 40.4168;
    const lng = -3.7038;

    // Crear mapa
    const map = L.map('map').setView([lat, lng], 12);

    // Cargar mapa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Marcador
    L.marker([lat, lng])
        .addTo(map)
        .bindPopup("Ubicaci√≥n aproximada del env√≠o.")
        .openPopup();

  // ====== Configuraci√≥n de la barra de impacto ======
  // Rango m√°ximo visible en la barra (kg CO2e)
  const CO2_MAX = 10;

  // Valores iniciales (puedes sustituir por datos reales)
  let co2Actual = 4.8;   // kg CO2e en modo Est√°ndar
  const ahorroPorc = 40; // % ahorro al pasar a ECO

  // Elementos del DOM
  const bar        = document.querySelector('.impact-bar');
  const barFill    = document.getElementById('impact-fill');
  const co2ValueEl = document.getElementById('co2-value');
  const savingEl   = document.getElementById('saving-percent');
  const noteEl     = document.getElementById('impact-note');
  const btnEco     = document.getElementById('btn-eco');

  // Inicializa textos
  savingEl.textContent = ahorroPorc.toString();

  // Funci√≥n para animar n√∫mero (ej. 4.8 -> 2.9)
  function animateNumber(el, from, to, duration = 600) {
    const start = performance.now();
    function tick(now) {
      const p = Math.min(1, (now - start) / duration);
      const value = from + (to - from) * p;
      el.textContent = value.toFixed(1);
      if (p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Funci√≥n para actualizar barra y accesibilidad
  function updateBar(valueKg) {
    const pct = Math.max(0, Math.min(100, (valueKg / CO2_MAX) * 100));
    barFill.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', valueKg.toFixed(1));
  }

  // Estado inicial
  co2ValueEl.textContent = co2Actual.toFixed(1);
  updateBar(co2Actual);

  // Al pulsar "Cambiar a Env√≠oEco" ‚Äî sincroniza la barra de impacto
  const btnEco2 = document.getElementById('btn-eco');
  if (btnEco2) {
    btnEco2.addEventListener('click', () => {
      // La barra se actualiza cuando el usuario confirma (ver confirmEco())
    });
  }

  // Funci√≥n auxiliar expuesta para que confirmEco() actualice la barra
  window.__updateImpactBar = function() {
      if (!selectedDays) return;
      const savingPct = Math.min(40 + (selectedDays - 2) * 2, 55);
      const nuevoValor = +(co2Actual * (1 - savingPct / 100)).toFixed(1);
      bar.classList.add('eco');
      animateNumber(co2ValueEl, co2Actual, nuevoValor, 700);
      updateBar(nuevoValor);
      noteEl.innerHTML = 'Has activado <strong>Env√≠oEco</strong>. Emisiones reducidas aproximadamente un ' + savingPct + '%.';
  };
</script>
