<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle de env√≠o ‚Äì DHL EcoPoints</title>
  <link rel="stylesheet" href="styles-envio.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Resultados pre-generados por el algoritmo Java -->
  <script src="eco-resultados.js"></script>

  <style>
    .container { max-width:960px; margin:40px auto; padding:0 20px; }
    .shipment-card {
      background:#fff; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:24px; display:grid; gap:16px;
    }
    .shipment-header {
      display:flex; justify-content:space-between;
      align-items:center; flex-wrap:wrap; gap:8px 16px;
    }
    .badge {
      display:inline-block; padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:700; letter-spacing:.3px;
      background:#ffe680; color:#7a5a00;
    }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .field { background:#fafafa; border-radius:8px; padding:12px 14px; }
    .field label { font-size:12px; color:#666; display:block; margin-bottom:6px; }
    .field div { font-size:16px; font-weight:600; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; margin-top:6px; }
    .btn-outline {
      background:transparent; border:2px solid #d40511; color:#d40511;
      padding:10px 18px; border-radius:6px; cursor:pointer;
      font-weight:600; transition:all .2s ease;
    }
    .btn-outline:hover { background:#ffd6d8; }
    .note {
      font-size:13px; color:#444;
      background:#fff9d6; border:1px solid #ffe58f;
      padding:10px 12px; border-radius:6px;
    }
    #map { height:350px; width:100%; border-radius:10px;
           margin-top:15px; box-shadow:0 2px 10px rgba(0,0,0,.15); }

    /* ‚îÄ‚îÄ Banner del algoritmo ‚îÄ‚îÄ */
    .algo-banner {
      display:none; margin-top:16px; margin-bottom:0;
      background:linear-gradient(135deg,#1b5e20,#388e3c);
      border-radius:10px; padding:16px 20px;
      color:#fff; flex-wrap:wrap; align-items:flex-start;
      gap:12px; animation:fadeIn .35s ease;
    }
    .algo-banner.visible { display:flex; }
    .algo-banner-label {
      font-size:11px; font-weight:800; letter-spacing:.6px;
      text-transform:uppercase; opacity:.65; width:100%; margin-bottom:4px;
    }
    .algo-stats-row { display:flex; gap:28px; flex-wrap:wrap; width:100%; }
    .algo-stat { display:flex; flex-direction:column; gap:1px; }
    .algo-stat .as-l { font-size:10px; opacity:.65; font-weight:700; letter-spacing:.3px; }
    .algo-stat .as-v { font-size:20px; font-weight:900; line-height:1.15; }
    .algo-stat .as-s { font-size:10px; opacity:.55; }

    /* ‚îÄ‚îÄ Eco panel ‚îÄ‚îÄ */
    .eco-panel {
      display:none; background:#f0faf0;
      border:2px solid #4caf50; border-radius:12px;
      padding:22px 24px; animation:slideDown .25s ease;
    }
    @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeIn    { from{opacity:0} to{opacity:1} }

    .eco-panel h3 { margin:0 0 4px; font-size:17px; color:#1b5e20; }
    .eco-intro    { margin:0 0 18px; font-size:13px; color:#555; }
    .eco-section-title {
      font-size:11px; font-weight:800; letter-spacing:.6px;
      text-transform:uppercase; color:#2e7d32; margin:0 0 10px;
    }
    .eco-divider { border:none; border-top:1px solid #c8e6c9; margin:16px 0; }

    .eco-panel-header {
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px; flex-wrap:wrap; margin-bottom:18px;
    }
    .eco-panel-header>div:first-child { flex:1; min-width:0; }
    .radius-control {
      display:flex; flex-direction:column; align-items:flex-end;
      gap:4px; flex-shrink:0; min-width:160px;
    }
    .radius-label { font-size:10px; font-weight:800; letter-spacing:.5px; text-transform:uppercase; color:#2e7d32; }
    .radius-row   { display:flex; align-items:center; gap:8px; }
    .radius-val   { font-size:13px; font-weight:900; color:#1b5e20; min-width:44px; text-align:right; }
    #radius-slider {
      -webkit-appearance:none; appearance:none; width:110px; height:4px;
      border-radius:4px; outline:none; cursor:pointer;
      background:linear-gradient(to right,#4caf50 0%,#4caf50 var(--pct,0%),#c8e6c9 var(--pct,0%),#c8e6c9 100%);
    }
    #radius-slider::-webkit-slider-thumb {
      -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
      background:#2e7d32; border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.25); cursor:pointer;
    }

    /* Loc list */
    .loc-list { display:flex; flex-direction:column; gap:6px; }
    .loc-row {
      display:flex; align-items:center; gap:12px;
      background:#fff; border:2px solid #c8e6c9;
      border-radius:10px; padding:10px 14px; cursor:pointer; transition:all .16s ease;
    }
    .loc-row:hover    { border-color:#4caf50; background:#f4fbf4; }
    .loc-row.selected { border-color:#2e7d32; background:#e8f5e9; box-shadow:0 0 0 3px rgba(46,125,50,.12); }
    .loc-row.no-eco   { border-color:#e0e0e0; }
    .loc-row.no-eco:hover    { border-color:#bbb; background:#fafafa; }
    .loc-row.no-eco.selected { border-color:#999; background:#f5f5f5; box-shadow:0 0 0 3px rgba(0,0,0,.06); }
    .loc-row.out-of-range    { display:none; }
    .loc-row-icon  { font-size:22px; flex-shrink:0; width:32px; text-align:center; }
    .loc-row-info  { flex:1; min-width:0; }
    .loc-row-name  { font-size:13px; font-weight:700; color:#1a1a1a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .loc-row-addr  { font-size:11px; color:#777; margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .loc-row-right { display:flex; flex-direction:column; align-items:flex-end; gap:4px; flex-shrink:0; }
    .loc-type-badge{ font-size:9px; font-weight:700; letter-spacing:.3px; text-transform:uppercase; color:#999; border:1px solid #ddd; border-radius:4px; padding:1px 6px; }
    .loc-pts-pill  { font-size:11px; font-weight:800; padding:2px 10px; border-radius:20px; }
    .loc-pts-pill.green { background:#c8e6c9; color:#1b5e20; }
    .loc-pts-pill.best  { background:#2e7d32; color:#fff; }
    .loc-pts-pill.none  { background:#f0f0f0; color:#aaa; }

    /* No-eco notice */
    .no-eco-notice {
      display:none; align-items:center; gap:10px;
      background:#fff8e1; border:1px solid #ffe082;
      border-radius:8px; padding:10px 14px; font-size:12px; color:#7a5a00;
    }
    .no-eco-notice.visible { display:flex; }

    /* Date options */
    .date-options { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; transition:opacity .2s; }
    .date-options.disabled { opacity:.35; pointer-events:none; }
    .date-opt {
      cursor:pointer; border:2px solid #c8e6c9; background:#fff;
      border-radius:10px; padding:12px 8px 10px; text-align:center;
      transition:all .18s ease; position:relative;
    }
    .date-opt:hover    { border-color:#4caf50; background:#f1f8f1; }
    .date-opt.selected { border-color:#2e7d32; background:#e8f5e9; box-shadow:0 0 0 3px rgba(46,125,50,.15); }
    .date-opt.best-combo { border-color:#ff8f00; background:#fff8e1; }
    .date-opt.best-combo.selected { border-color:#ff8f00; background:#fff3cd; box-shadow:0 0 0 3px rgba(255,143,0,.2); }
    .date-opt.best-combo .dopt-pts { background:#ff8f00; }
    .dopt-day  { font-size:12px; font-weight:800; color:#1a1a1a; }
    .dopt-date { font-size:10px; color:#666; margin:2px 0 4px; }
    .dopt-delay{ font-size:10px; color:#888; margin-bottom:5px; }
    .dopt-pts  { display:inline-block; background:#2e7d32; color:#fff; font-size:11px; font-weight:800; padding:3px 10px; border-radius:20px; }
    .dopt-co2  { display:block; font-size:9px; color:#4caf50; margin-top:4px; font-weight:700; }
    .best-tag  { position:absolute; top:-1px; right:-1px; background:#ff8f00; color:#fff; font-size:9px; font-weight:800; padding:2px 7px; border-radius:0 8px 0 8px; }

    /* Desglose */
    .pts-breakdown {
      display:none; background:#e8f5e9; border:1px solid #a5d6a7;
      border-radius:8px; padding:12px 16px; font-size:12px; color:#1b5e20;
      margin-top:-4px; animation:fadeIn .2s ease;
    }
    .pts-breakdown.visible { display:block; }
    .bd-title { font-size:10px; font-weight:800; letter-spacing:.4px; text-transform:uppercase; color:#2e7d32; margin-bottom:8px; }
    .pts-breakdown table { width:100%; border-collapse:collapse; }
    .pts-breakdown td   { padding:3px 4px; }
    .pts-breakdown td:last-child { text-align:right; font-weight:800; }
    .pts-breakdown tr.bd-total td { border-top:1px solid #a5d6a7; font-weight:900; color:#2e7d32; padding-top:6px; }

    /* Live bar */
    .pts-live-bar {
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; border:1px solid #c8e6c9; border-radius:10px;
      padding:12px 18px; gap:12px; flex-wrap:wrap; margin-top:8px;
    }
    .pts-live-breakdown { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pli { display:flex; flex-direction:column; gap:1px; }
    .pli-label { font-size:9px; font-weight:800; color:#aaa; letter-spacing:.5px; text-transform:uppercase; }
    .pli-val   { font-size:14px; font-weight:800; color:#555; transition:color .2s; }
    .pli-val.active { color:#2e7d32; }
    .pts-live-sep { color:#ccc; font-size:16px; }
    .pts-live-total { display:flex; flex-direction:column; align-items:flex-end; }
    .plt-label { font-size:9px; font-weight:800; color:#aaa; letter-spacing:.5px; text-transform:uppercase; }
    .plt-val   { font-size:28px; font-weight:900; color:#bbb; line-height:1; transition:color .25s,transform .2s; }
    .plt-val.has-value { color:#1b5e20; }
    .plt-val.bump { transform:scale(1.14); }

    /* CO2 chip */
    .co2-chip {
      display:none; align-items:center; gap:6px;
      background:#e8f5e9; border:1px solid #a5d6a7;
      border-radius:20px; padding:5px 14px; font-size:12px; font-weight:700; color:#1b5e20;
      margin-top:8px;
    }
    .co2-chip.visible { display:flex; }

    /* Confirm */
    .btn-confirm-eco {
      background:linear-gradient(135deg,#2e7d32,#4caf50);
      color:#fff; border:none; padding:13px 26px; border-radius:8px;
      font-size:14px; font-weight:700; cursor:pointer; transition:opacity .2s;
      width:100%; margin-top:14px;
    }
    .btn-confirm-eco:disabled { opacity:.38; cursor:default; }
    .btn-confirm-eco:not(:disabled):hover { opacity:.88; }
    .eco-confirm-hint { text-align:center; font-size:12px; color:#888; margin:6px 0 0; }
    .eco-confirm-hint.ready { color:#2e7d32; font-weight:600; }

    /* Activation msg */
    .eco-activated-msg {
      display:none; align-items:center; gap:12px;
      background:#e8f5e9; border:1px solid #a5d6a7;
      border-radius:8px; padding:14px 18px; font-size:14px;
      color:#1b5e20; font-weight:600; flex-wrap:wrap; margin-top:14px;
    }
    .eco-activated-msg.visible { display:flex; }
    .eco-activated-msg .pts-pill {
      background:#2e7d32; color:#fff; border-radius:20px;
      padding:4px 14px; font-size:15px; font-weight:800; white-space:nowrap; margin-left:auto;
    }

    /* Dashboard */
    .dashboard-section {
      background:#fff; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:24px; margin-top:24px; display:none;
      animation:fadeIn .4s ease;
    }
    .dashboard-section h2 { margin:0 0 4px; font-size:18px; }
    .dash-subtitle { font-size:13px; color:#666; margin:0 0 18px; }
    .dash-kpis { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
    .dash-kpi { background:#f4fbf4; border:1px solid #c8e6c9; border-radius:8px; padding:14px; }
    .dash-kpi .kpi-l { font-size:10px; font-weight:800; color:#999; letter-spacing:.5px; text-transform:uppercase; }
    .dash-kpi .kpi-v { font-size:24px; font-weight:900; color:#1b5e20; margin-top:3px; }
    .dash-kpi .kpi-s { font-size:11px; color:#888; margin-top:1px; }
    .pedidos-wrap { overflow:auto; max-height:300px; border-radius:8px; border:1px solid #e8e8e8; }
    .pedidos-table { width:100%; border-collapse:collapse; font-size:12px; }
    .pedidos-table thead th {
      position:sticky; top:0; background:#1b5e20; color:#fff;
      padding:8px 10px; text-align:left; font-size:11px; font-weight:800; letter-spacing:.3px;
    }
    .pedidos-table tbody tr { border-bottom:1px solid #f0f0f0; }
    .pedidos-table tbody tr:hover { background:#f0faf0; }
    .pedidos-table tbody td { padding:7px 10px; color:#333; }
    .eco-badge { background:#e8f5e9; color:#1b5e20; border-radius:10px; padding:2px 8px; font-size:10px; font-weight:800; }
    .std-badge { background:#fff3e0; color:#e65100; border-radius:10px; padding:2px 8px; font-size:10px; font-weight:800; }

    @media(max-width:720px){
      .row,.date-options,.dash-kpis{ grid-template-columns:1fr; }
      .dash-kpis { grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>

  <header>
    <div><a href="index.html" style="text-decoration:none;"><strong class="logo">HackatonDHL</strong></a></div>
    <nav>
      <a href="index.html">Haga seguimiento</a>
      <a href="#">Enviar</a>
      <a href="#">Servicios de log√≠stica</a>
      <a href="#">Servicio al cliente</a>
    </nav>
    <a href="profile.html" class="header-profile">
      <span class="header-avatar">CM</span>
      <span class="header-username">Carlos M.</span>
    </a>
  </header>

  <main class="container">
    <h1 style="margin:10px 0 18px;">Detalle del env√≠o</h1>
    <h2 style="margin-top:40px;">Ubicaci√≥n del env√≠o</h2>
    <div id="map"></div>

    <!-- Banner resultados del algoritmo (visible siempre) -->
    <div class="algo-banner visible" id="algo-banner">
      <div class="algo-banner-label">ü§ñ Resultados del algoritmo de optimizaci√≥n ¬∑ zona 28931 ¬∑ ejecutado offline</div>
      <div class="algo-stats-row">
        <div class="algo-stat">
          <span class="as-l">Pedidos analizados</span>
          <span class="as-v">500</span>
          <span class="as-s">14 d√≠as simulados</span>
        </div>
        <div class="algo-stat">
          <span class="as-l">Rutas evaluadas</span>
          <span class="as-v">84</span>
          <span class="as-s">domicilio + 5 puntos eco</span>
        </div>
        <div class="algo-stat">
          <span class="as-l">CO‚ÇÇ evitable total</span>
          <span class="as-v">1.582 kg</span>
          <span class="as-s">si todos activan Env√≠oEco</span>
        </div>
        <div class="algo-stat">
          <span class="as-l">Ahorro log√≠stico</span>
          <span class="as-v">6.412 ‚Ç¨</span>
          <span class="as-s">rutas consolidadas</span>
        </div>
      </div>
    </div>

    <section class="shipment-card" id="card" style="margin-top:16px;">
      <div class="shipment-header">
        <div>
          <div style="font-size:18px;font-weight:800;">Env√≠o #1234 5678 90</div>
          <span class="badge" id="badge-servicio">Servicio: Est√°ndar</span>
        </div>
        <div class="actions">
          <button class="btn-outline" id="btn-eco">üçÉ Cambiar a Env√≠oEco</button>
          <a class="btn" href="index.html">Volver</a>
        </div>
      </div>

      <!-- ECO PANEL -->
      <div class="eco-panel" id="eco-panel">

        <div class="eco-panel-header">
          <div>
            <h3>üåø Configura tu Env√≠oEco</h3>
            <p class="eco-intro">
              Puntos calculados por el optimizador sobre <strong>84 rutas futuras</strong>
              de la zona 28931. Los valores provienen directamente de la salida del algoritmo.
            </p>
          </div>
          <div class="radius-control">
            <span class="radius-label">üìç Radio de b√∫squeda</span>
            <div class="radius-row">
              <input type="range" id="radius-slider" min="1" max="10" value="3" step="0.5"
                     oninput="onRadiusChange(this)">
              <span class="radius-val" id="radius-val">3 km</span>
            </div>
          </div>
        </div>

        <p class="eco-section-title">üìç Selecciona un punto de recogida</p>
        <div class="loc-list" id="loc-list">
          <!-- Domicilio -->
          <div class="loc-row no-eco" data-eco="false" data-dist="0"
               data-loc-label="Tu casa (C/ Portillo, 42)" onclick="selectLoc(this)">
            <div class="loc-row-icon">üè†</div>
            <div class="loc-row-info">
              <div class="loc-row-name">Tu casa</div>
              <div class="loc-row-addr">C/ Portillo, 42 ‚Äì Piso 3¬∫ B</div>
            </div>
            <div class="loc-row-right">
              <span class="loc-type-badge">Domicilio</span>
              <span class="loc-pts-pill none">Sin EcoPoints</span>
            </div>
          </div>
          <!-- Puntos del algoritmo -->
          <div id="loc-rows-algo"></div>
        </div>

        <hr class="eco-divider">

        <p class="eco-section-title">üìÖ ¬øCu√°ndo puedes recibirlo?</p>
        <div class="no-eco-notice" id="no-eco-notice">
          <span style="font-size:18px">‚ö†Ô∏è</span>
          <span>La entrega a <strong>domicilio</strong> no genera EcoPoints. Elige un punto de recogida.</span>
        </div>
        <div class="date-options" id="date-options"></div>

        <hr class="eco-divider">

        <!-- Desglose del algoritmo -->
        <div class="pts-breakdown" id="pts-breakdown">
          <div class="bd-title">üìä Desglose calculado por OptimizadorEcoPuntosFinal.java</div>
          <table>
            <tr><td>‚õΩ Ahorro bruto en gasolina/ruta</td>             <td id="bd-gasolina">‚Äî</td></tr>
            <tr><td>üì¶ Coste de almacenaje (<span id="bd-dias-label">0</span> d√≠as √ó 0.15‚Ç¨)</td><td id="bd-almacenaje">‚Äî</td></tr>
            <tr><td>‚úÖ Ahorro neto = bruto ‚àí almacenaje</td>          <td id="bd-neto">‚Äî</td></tr>
            <tr><td>ü§ù F√≥rmula: round(ahorroNeto √ó 50%) √∑ 0.10‚Ç¨/pt</td><td id="bd-formula">‚Äî</td></tr>
            <tr class="bd-total"><td>Total EcoPoints (m√≠n. 5)</td>    <td id="bd-total">‚Äî</td></tr>
          </table>
        </div>

        <!-- Barra live -->
        <div class="pts-live-bar">
          <div class="pts-live-breakdown">
            <div class="pli">
              <span class="pli-label">Por ubicaci√≥n</span>
              <span class="pli-val" id="pli-loc">‚Äî</span>
            </div>
            <span class="pts-live-sep">+</span>
            <div class="pli">
              <span class="pli-label">Por fecha</span>
              <span class="pli-val" id="pli-date">‚Äî</span>
            </div>
            <span class="pts-live-sep">=</span>
          </div>
          <div class="pts-live-total">
            <span class="plt-label">Total EcoPoints</span>
            <span class="plt-val" id="plt-val">‚Äî</span>
          </div>
        </div>

        <!-- CO2 chip -->
        <div class="co2-chip" id="co2-chip">
          <span>üåø</span><span id="co2-chip-text">‚Äî</span>
        </div>

        <button class="btn-confirm-eco" id="btn-confirm" disabled onclick="confirmEco()">
          Confirmar Env√≠oEco
        </button>
        <p class="eco-confirm-hint" id="eco-confirm-hint">Selecciona una ubicaci√≥n y una fecha para continuar</p>

        <div class="eco-activated-msg" id="eco-activated">
          <div>
            <div>‚úÖ Env√≠oEco activado</div>
            <div style="font-size:13px;font-weight:400;margin-top:3px;">
              Entrega el <strong id="activated-date">‚Äî</strong> ¬∑ <span id="activated-loc-label">‚Äî</span>
            </div>
          </div>
          <span class="pts-pill" id="activated-pts">‚Äî</span>
        </div>
      </div>

      <div class="row">
        <div class="field"><label>Estado</label>          <div id="estado">En tr√°nsito</div></div>
        <div class="field"><label>Entrega estimada</label><div>Martes 25 de febrero, 12:00‚Äì16:00</div></div>
      </div>
      <div class="row">
        <div class="field"><label>Origen</label>  <div>Madrid, ES</div></div>
        <div class="field"><label>Destino</label> <div>Barcelona, ES</div></div>
      </div>
      <p class="note" id="nota">
        Este env√≠o usa el servicio Est√°ndar. Puedes cambiar a <strong>Env√≠oEco</strong> para reducir tu huella de carbono.
      </p>
    </section>

    <!-- Impacto ambiental -->
    <section class="impact-section" aria-labelledby="impact-title">
      <h2 id="impact-title">Impacto ambiental del env√≠o</h2>
      <div class="impact-summary">
        <div class="impact-item">
          <span class="label">Emisiones estimadas</span>
          <span class="value"><span id="co2-value">4.8</span> kg CO‚ÇÇe</span>
        </div>
        <div class="impact-item">
          <span class="label">Ahorro con Env√≠oEco</span>
          <span class="value saving">hasta <span id="saving-percent">40</span>%</span>
        </div>
      </div>
      <div class="impact-bar" role="progressbar" aria-valuemin="0" aria-valuemax="10"
           aria-valuenow="4.8" aria-label="Emisiones CO2">
        <div class="impact-bar__fill" id="impact-fill" style="width:48%"></div>
      </div>
      <p class="impact-note" id="impact-note">
        Este env√≠o usa el servicio <strong>Est√°ndar</strong>. Cambia a <strong>Env√≠oEco</strong> para reducir las emisiones de CO‚ÇÇe.
      </p>
    </section>

    <!-- Dashboard resultados algoritmo -->
    <section class="dashboard-section" id="dashboard-section">
      <h2>üìä Resultados del algoritmo ‚Äì Dataset completo</h2>
      <p class="dash-subtitle">
        Salida del optimizador Java ejecutado sobre <strong>500 pedidos simulados</strong>
        en la zona postal <strong>28931 (M√≥stoles)</strong> ¬∑ 14 d√≠as de horizonte de planificaci√≥n.
      </p>
      <div class="dash-kpis">
        <div class="dash-kpi">
          <div class="kpi-l">Total pedidos</div>
          <div class="kpi-v">500</div>
          <div class="kpi-s">zona 28931 ¬∑ 14 d√≠as</div>
        </div>
        <div class="dash-kpi">
          <div class="kpi-l">Con Env√≠oEco activo</div>
          <div class="kpi-v">167</div>
          <div class="kpi-s">33% del total (simulado)</div>
        </div>
        <div class="dash-kpi">
          <div class="kpi-l">CO‚ÇÇ evitado</div>
          <div class="kpi-v">1.582 kg</div>
          <div class="kpi-s">vs entrega est√°ndar</div>
        </div>
        <div class="dash-kpi">
          <div class="kpi-l">Ahorro log√≠stico</div>
          <div class="kpi-v">6.412 ‚Ç¨</div>
          <div class="kpi-s">rutas consolidadas</div>
        </div>
      </div>
      <div class="pedidos-wrap">
        <table class="pedidos-table">
          <thead>
            <tr>
              <th>#</th><th>ID Env√≠o</th><th>Destinatario</th>
              <th>Entrega</th><th>Peso</th><th>CO‚ÇÇ base</th><th>Estado</th>
            </tr>
          </thead>
          <tbody id="pedidos-tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const R = ECO_RESULTADOS;

    // ‚îÄ‚îÄ Construir filas de ubicaci√≥n desde maximosPorUbicacion ‚îÄ‚îÄ
    (function () {
      const container = document.getElementById('loc-rows-algo');
      const maxGlobal = Math.max(...R.maximosPorUbicacion.map(p => p.maxPts));

      R.maximosPorUbicacion.forEach(p => {
        const isBest = p.maxPts === maxGlobal;
        const pill = isBest
          ? `<span class="loc-pts-pill best">‚≠ê hasta +${p.maxPts} pts</span>`
          : `<span class="loc-pts-pill green">hasta +${p.maxPts} pts</span>`;

        const row = document.createElement('div');
        row.className = 'loc-row';
        row.dataset.eco      = 'true';
        row.dataset.dist     = p.dist;
        row.dataset.nombre   = p.nombre;
        row.dataset.locLabel = p.nombre;
        row.innerHTML = `
          <div class="loc-row-icon">${p.icono}</div>
          <div class="loc-row-info">
            <div class="loc-row-name">${p.nombre}</div>
            <div class="loc-row-addr">${p.tipo} ¬∑ ${p.dist} km de tu casa</div>
          </div>
          <div class="loc-row-right">
            <span class="loc-type-badge">${p.tipo}</span>
            ${pill}
          </div>`;
        row.addEventListener('click', () => selectLoc(row));
        container.appendChild(row);
      });
    })();

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let selNombre = null, selLocLabel = null, selEco = null;
    let selDays = null, selOp = null;

    // ‚îÄ‚îÄ Panel toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('btn-eco').addEventListener('click', function () {
      if (this.disabled) return;
      const panel = document.getElementById('eco-panel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    // ‚îÄ‚îÄ Radius ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function onRadiusChange(slider) {
      const km = parseFloat(slider.value);
      slider.style.setProperty('--pct', ((km-1)/9*100)+'%');
      document.getElementById('radius-val').textContent = km%1===0 ? km+' km' : km.toFixed(1)+' km';
      document.querySelectorAll('.loc-row').forEach(row => {
        const dist = parseFloat(row.dataset.dist||0);
        const inRange = dist === 0 || dist <= km;
        row.classList.toggle('out-of-range', !inRange);
        if (!inRange && row.classList.contains('selected')) resetSel();
      });
    }
    (function(){
      const s = document.getElementById('radius-slider');
      s.style.setProperty('--pct', ((parseFloat(s.value)-1)/9*100)+'%');
      onRadiusChange(s);
    })();

    // ‚îÄ‚îÄ Location ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function selectLoc(el) {
      document.querySelectorAll('.loc-row').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selEco      = el.dataset.eco !== 'false';
      selLocLabel = el.dataset.locLabel;
      selNombre   = el.dataset.nombre || null;
      selDays = null; selOp = null;

      document.getElementById('no-eco-notice').classList.toggle('visible', !selEco);
      document.getElementById('pts-breakdown').classList.remove('visible');
      document.getElementById('co2-chip').classList.remove('visible');
      document.getElementById('pli-loc').textContent = '‚Äî';
      document.getElementById('pli-loc').classList.remove('active');
      document.getElementById('pli-date').textContent = '‚Äî';
      document.getElementById('pli-date').classList.remove('active');

      buildDateCards();
      updateLiveBar();
    }

    // ‚îÄ‚îÄ Date cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildDateCards() {
      const container = document.getElementById('date-options');
      container.innerHTML = '';
      container.classList.toggle('disabled', !selEco);
      if (!selEco || !selNombre) return;

      const opcionesPunto = R.fechasPorUbicacion[selNombre] || [];
      const maxPts = Math.max(...opcionesPunto.map(o => o.pts));

      opcionesPunto.forEach(op => {
        const isBest = op.pts === maxPts;
        const div = document.createElement('div');
        div.className = 'date-opt' + (isBest ? ' best-combo' : '');
        div.innerHTML = `
          ${isBest ? '<span class="best-tag">‚≠ê M√°ximo</span>' : ''}
          <div class="dopt-day">${op.fecha.split(' ')[0]}</div>
          <div class="dopt-date">${op.fecha.split(' ').slice(1).join(' ')}</div>
          <div class="dopt-delay">+${op.diasRetraso} d√≠a${op.diasRetraso>1?'s':''}</div>
          <span class="dopt-pts">+${op.pts} pts</span>
          <span class="dopt-co2">üì¶ ${op.paquetesAgrupados} paquetes agrupados</span>
        `;
        div.addEventListener('click', () => selectDate(div, op));
        container.appendChild(div);
      });
    }

    // ‚îÄ‚îÄ Date select ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function selectDate(el, op) {
      document.querySelectorAll('.date-opt').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selDays = op.diasRetraso; selOp = op;

      // Desglose nuevo: ahorroNeto = ahorroBrutoGasolina - costoAlmacenaje
      document.getElementById('bd-gasolina').textContent   = '+'+op.ahorroBrutoGasolina.toFixed(2)+'‚Ç¨';
      document.getElementById('bd-dias-label').textContent = op.diasRetraso;
      document.getElementById('bd-almacenaje').textContent = '‚àí'+(op.costoAlmacenaje).toFixed(2)+'‚Ç¨';
      document.getElementById('bd-neto').textContent       = op.ahorroNeto.toFixed(2)+'‚Ç¨';
      document.getElementById('bd-formula').textContent    = 'round('+op.ahorroNeto.toFixed(2)+'√ó0.5√∑0.10)';
      document.getElementById('bd-total').textContent      = '+'+op.pts+' pts';
      document.getElementById('pts-breakdown').classList.add('visible');

      // CO2 chip ‚Üí ahora muestra paquetes agrupados y ahorro neto
      document.getElementById('co2-chip-text').textContent =
        `${op.paquetesAgrupados} paquetes agrupados ¬∑ DHL ahorra ${op.ahorroNeto.toFixed(2)}‚Ç¨ netos`;
      document.getElementById('co2-chip').classList.add('visible');

      // Barra live: toda la ganancia viene del ahorro neto, no hay split loc/fecha
      // Mostramos ahorroBruto en "ubicaci√≥n" y costoAlmacenaje en "fecha" como contexto
      const pliLoc  = document.getElementById('pli-loc');
      const pliDate = document.getElementById('pli-date');
      pliLoc.textContent  = '+'+op.ahorroBrutoGasolina.toFixed(2)+'‚Ç¨ bruto'; pliLoc.classList.add('active');
      pliDate.textContent = '‚àí'+op.costoAlmacenaje.toFixed(2)+'‚Ç¨ almac.';    pliDate.classList.add('active');

      updateLiveBar();
    }

    // ‚îÄ‚îÄ Live bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateLiveBar() {
      const pltEl = document.getElementById('plt-val');
      const hint  = document.getElementById('eco-confirm-hint');
      const btn   = document.getElementById('btn-confirm');

      if (!selEco) {
        pltEl.textContent='0 pts'; pltEl.classList.remove('has-value');
        hint.textContent='Esta ubicaci√≥n no genera EcoPoints. Selecciona otro punto.';
        hint.classList.remove('ready'); btn.disabled=true;
      } else if (selOp) {
        pltEl.textContent='+'+selOp.pts+' pts';
        pltEl.classList.add('has-value','bump');
        setTimeout(()=>pltEl.classList.remove('bump'),300);
        btn.disabled=false;
        hint.textContent='¬°Listo! Pulsa Confirmar para activar Env√≠oEco';
        hint.classList.add('ready');
      } else if (selNombre) {
        pltEl.textContent='‚Äî'; pltEl.classList.remove('has-value');
        hint.textContent='Ahora selecciona una fecha de entrega';
        hint.classList.remove('ready'); btn.disabled=true;
      } else {
        pltEl.textContent='‚Äî'; pltEl.classList.remove('has-value');
        hint.textContent='Selecciona un punto de recogida y una fecha';
        hint.classList.remove('ready'); btn.disabled=true;
      }
    }

    function resetSel() {
      selNombre=null; selLocLabel=null; selEco=null; selDays=null; selOp=null;
      ['pli-loc','pli-date'].forEach(id=>{
        document.getElementById(id).textContent='‚Äî';
        document.getElementById(id).classList.remove('active');
      });
      document.getElementById('no-eco-notice').classList.remove('visible');
      document.getElementById('pts-breakdown').classList.remove('visible');
      document.getElementById('co2-chip').classList.remove('visible');
      document.getElementById('date-options').innerHTML='';
      updateLiveBar();
    }

    // ‚îÄ‚îÄ Confirm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function confirmEco() {
      document.querySelectorAll('.loc-row,.date-opt').forEach(o=>{
        o.style.pointerEvents='none'; o.style.opacity='.5';
      });
      document.querySelectorAll('.loc-row.selected,.date-opt.selected').forEach(o=>o.style.opacity='1');
      document.getElementById('radius-slider').disabled=true;
      document.getElementById('btn-confirm').style.display='none';
      document.getElementById('eco-confirm-hint').style.display='none';

      document.getElementById('activated-date').textContent      = selOp.fecha;
      document.getElementById('activated-loc-label').textContent = selLocLabel;
      document.getElementById('activated-pts').textContent       = `+${selOp.pts} üçÉ pts`;
      document.getElementById('eco-activated').classList.add('visible');

      const badge = document.getElementById('badge-servicio');
      const nota  = document.getElementById('nota');
      const estado= document.getElementById('estado');
      if (badge)  { badge.textContent='Servicio: Env√≠oEco ‚ôª'; badge.style.background='#d9f7be'; badge.style.color='#135200'; }
      if (estado) estado.textContent='En tr√°nsito (modo ecol√≥gico)';
      if (nota)   nota.innerHTML = `Has activado <strong>Env√≠oEco</strong>. Entrega el <strong>${selOp.fecha}</strong> en <strong>${selLocLabel}</strong>. Ganar√°s <strong>+${selOp.pts} EcoPoints</strong> al agrupar <strong>${selOp.paquetesAgrupados} paquetes</strong> (ahorro neto DHL: ${selOp.ahorroNeto.toFixed(2)}‚Ç¨).`;

      const btnEco = document.getElementById('btn-eco');
      btnEco.textContent='‚úÖ Env√≠oEco activado'; btnEco.disabled=true;
      btnEco.style.opacity='.7'; btnEco.style.cursor='default';

      if (window.__updateImpactBar) window.__updateImpactBar();
      renderDashboard();
    }

    // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderDashboard() {
      const section = document.getElementById('dashboard-section');
      section.style.display='block';
      section.scrollIntoView({behavior:'smooth', block:'start'});

      document.getElementById('pedidos-tbody').innerHTML =
        R.pedidosMuestra.map((p,i) => `
          <tr>
            <td>${i+1}</td>
            <td><strong>${p.id}</strong></td>
            <td>${p.destinatario}</td>
            <td>${p.fecha}</td>
            <td>${p.peso} kg</td>
            <td>${p.co2} kg</td>
            <td>${p.eco ? '<span class="eco-badge">‚úÖ Env√≠oEco</span>' : '<span class="std-badge">Est√°ndar</span>'}</td>
          </tr>`).join('');
    }
  </script>

  <script>
    // Mapa (M√≥stoles)
    const map = L.map('map').setView([40.3228,-3.8654],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
    L.marker([40.3228,-3.8654]).addTo(map)
      .bindPopup("Ubicaci√≥n aproximada del env√≠o.").openPopup();

    const pCoords = {
      P1:[40.3228,-3.8645], P2:[40.3241,-3.8612],
      P3:[40.3256,-3.8590], P4:[40.3190,-3.8701], P5:[40.4065,-3.6895]
    };
    const pNombres = {
      P1:'üì® Correos', P2:'üé´ Lotter√≠as', P3:'üõí Supermercado D√≠a',
      P4:'üíä Farmacia Central', P5:'üì¶ Casillero DHL'
    };
    Object.entries(pCoords).forEach(([id,[lat,lng]])=>{
      L.circleMarker([lat,lng],{radius:8,color:'#2e7d32',fillColor:'#4caf50',fillOpacity:.85})
       .addTo(map).bindPopup(`<strong>${pNombres[id]}</strong>`);
    });

    // Barra CO2
    const co2Actual = 4.8;
    const bar = document.querySelector('.impact-bar');
    const barFill = document.getElementById('impact-fill');
    const co2El   = document.getElementById('co2-value');
    const noteEl  = document.getElementById('impact-note');

    function animN(el,from,to,dur=600){
      const t0=performance.now();
      (function f(now){ const p=Math.min(1,(now-t0)/dur); el.textContent=(from+(to-from)*p).toFixed(1); if(p<1)requestAnimationFrame(f); })(performance.now());
    }
    function setBar(v){ barFill.style.width=Math.max(0,Math.min(100,v/10*100))+'%'; bar.setAttribute('aria-valuenow',v.toFixed(1)); }

    co2El.textContent = co2Actual.toFixed(1); setBar(co2Actual);

    window.__updateImpactBar = function(){
      if (!selOp) return;
      // La reducci√≥n de CO2 se estima proporcional al ahorro neto (consolidaci√≥n de rutas)
      const pct  = Math.min(20 + selOp.diasRetraso * 3, 50);
      const nuevo = +(co2Actual*(1-pct/100)).toFixed(1);
      bar.classList.add('eco');
      animN(co2El, co2Actual, nuevo, 700);
      setBar(nuevo);
      noteEl.innerHTML = `Has activado <strong>Env√≠oEco</strong>. Reducci√≥n estimada de emisiones: ~${pct}% gracias a la consolidaci√≥n de <strong>${selOp.paquetesAgrupados} paquetes</strong> en una misma ruta.`;
    };
  </script>
</body>
</html>